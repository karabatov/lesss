
<!DOCTYPE html>
<html>
    <head>
        <link href='http://fonts.googleapis.com/css?family=OFL+Sorts+Mill+Goudy+TT:regular,italic' rel='stylesheet' type='text/css' />
        <link rel="profile" href="http://microformats.org/profile/hcard" />
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />

        <title>A Git User's Guide to Mercurial Queues / Steve Losh</title>

        
            <link href="http://feeds2.feedburner.com/stevelosh"
                  rel="alternate" title="Steve Losh"
                  type="application/atom+xml" />
        

        
            <link rel="stylesheet" href="/media/css/aal.css"      type="text/css" media="screen" charset="utf-8" />
            <link rel="stylesheet" href="/media/css/sjl.css"      type="text/css" media="screen" charset="utf-8" />
            <link rel="stylesheet" href="/media/css/print.css"    type="text/css" media="print" charset="utf-8" />
            
    <link rel="stylesheet"
          href="/media/css/pygments-monokai-light.css"
          type="text/css" media="screen" charset="utf-8" />

        

        
            <script src="/media/js/jquery.js" type="text/javascript"></script>
            <script src="/media/js/jquery.timeago.js" type="text/javascript"></script>
            <script src="/media/js/sjl.js" type="text/javascript"></script>
            <script src="/media/js/print.js" type="text/javascript"></script>

            <script type="text/javascript">
                $(function() {
                    $("a.rhythm").toggle(function() {
                        $("body").addClass("rhythm");
                    }, function() {
                        $("body").removeClass("rhythm");
                    });
                });
            </script>

            <script type="text/javascript">
            /* <![CDATA[ */
                (function() {
                    var s = document.createElement('script'), t = document.getElementsByTagName('script')[0];

                    s.type = 'text/javascript';
                    s.async = true;
                    s.src = 'http://api.flattr.com/js/0.5.0/load.js?mode=auto';

                    t.parentNode.insertBefore(s, t);
                })();
            /* ]]> */
            </script>

            
        

        <link rel="openid.server" href="http://www.myopenid.com/server" />
        <link rel="openid.delegate" href="http://stevelosh.myopenid.com/" />

        <script type="text/javascript">
          var _gaq = _gaq || [];
          _gaq.push(['_setAccount', 'UA-15328874-2']);
          _gaq.push(['_trackPageview']);

          (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
          })();
        </script>

    </head>

    <body>
        <div class="wrap">
            <div class="top group">
                <header>
                    <a href="/">steve losh</a>
                </header>

                <nav>
                    <a href="/blog/">Blog</a>
                    <span class="sep">-</span>
                    <a href="/projects">Projects</a>
                    <span class="sep">-</span>
                    <a href="/about/">About</a>
                    <span class="sep">-</span>
                    <a href="http://feeds2.feedburner.com/stevelosh">Feed</a>
                </nav>
            </div>

            <div class="hr">&nbsp;</div>

            <div class="content">
                
                    
                        
    <div id="leaf-title">
        <h1><a href="/blog/2010/08/a-git-users-guide-to-mercurial-queues/">A Git User&#8217;s Guide to Mercurial&nbsp;Queues</a></h1>
    </div>


    <div id="leaf-stats" class="group">
        
            <div class="flattr">
                <a class="FlattrButton" style="display:none;" rev="flattr;button:compact;"
                   href="http://stevelosh.com/blog/2010/08/a-git-users-guide-to-mercurial-queues/"></a>
           </div>
        
        <p>
            Posted
            <span class="timeago"
                  title="2010-08-10T21:00:00">
            </span>
            on August 10, 2010.
        </p>
    </div>

    <div id="leaf-content" class="with-diagrams">
        
            <!-- Hyde::Article::Begin -->
                
                    <p>I&#8217;ve been using <a href="http://mercurial.selenic.com/wiki/MqExtension">Mercurial Queues</a> more and more lately. At the last
Mercurial sprint <a href="http://cs.ubc.ca/~brendan/">Brendan Cully</a> said something that made me realize
that <span class="caps"><span class="caps">MQ</span></span> behaves very much like a souped-up version of <a href="http://git-scm.com/">git</a>&#8216;s&nbsp;index.</p>
<p>I wanted to write a blog post about the similarities between the two concepts
so that git users could understand <a href="http://mercurial.selenic.com/">Mercurial</a>&#8216;s <span class="caps"><span class="caps">MQ</span></span> extension a bit better
and see how it can take that concept even further than&nbsp;git&nbsp;does.</p>
<p>This post is <em>not</em> intended to be a guide to <span class="caps"><span class="caps">MQ</span></span>&#8217;s day-to-day commands &#8212; it&#8217;s
simply trying to explain <span class="caps"><span class="caps">MQ</span></span> in a way that git users might find more
understandable.  For a primer on <span class="caps"><span class="caps">MQ</span></span> commands you can check out <a href="http://hgbook.red-bean.com/read/managing-change-with-mercurial-queues.html">the <span class="caps"><span class="caps">MQ</span></span> chapter
in the hg book</a>.</p>
<div class="toc">
<ul>
<li><a href="#git-basics">Git&nbsp;Basics</a></li>
<li><a href="#mercurial-basics">Mercurial&nbsp;Basics</a></li>
<li><a href="#using-mq-with-a-single-patch">Using <span class="caps"><span class="caps">MQ</span></span> with a&nbsp;Single&nbsp;Patch</a></li>
<li><a href="#using-mq-with-two-or-more-patches">Using <span class="caps"><span class="caps">MQ</span></span> with Two (or&nbsp;More)&nbsp;Patches</a></li>
<li><a href="#multiple-patch-queues">Multiple&nbsp;Patch&nbsp;Queues</a></li>
<li><a href="#versioned-patch-queues">Versioned&nbsp;Patch&nbsp;Queues</a></li>
<li><a href="#problems-with-mq">Problems with&nbsp;<span class="caps"><span class="caps">MQ</span></span></a></li>
</ul>
</div>
<h2 id="git-basics">Git&nbsp;Basics</h2>
<p>Let&#8217;s take a few moments to review how git works so we&#8217;re all on the same page
with&nbsp;our&nbsp;terminology.</p>
<p>When you&#8217;re working with a git repository you have three &#8220;layers&#8221; to&nbsp;work&nbsp;with:</p>
<ul>
<li>The&nbsp;working&nbsp;directory</li>
<li>The&nbsp;index</li>
<li>The&nbsp;git&nbsp;repository</li>
</ul>
<p>You use <code>git add</code> to shove changes from the working directory into the index
and <code>git commit</code> to shove changes from the index into&nbsp;the&nbsp;repository:</p>
<p><img alt="Git Basics Diagram" src="/media/images/blog/2010/08/git-basics.png" title="Git Basics" /></p>
<p>This is a very powerful model because it lets you build your changesets
piece-by-piece and commit them permanently only when&nbsp;you&#8217;re&nbsp;ready.</p>
<h2 id="mercurial-basics">Mercurial&nbsp;Basics</h2>
<p>With basic, stock Mercurial you only have two &#8220;layers&#8221; to&nbsp;work&nbsp;with:</p>
<ul>
<li>The&nbsp;working&nbsp;directory</li>
<li>The&nbsp;Mercurial&nbsp;repository</li>
</ul>
<p>You use <code>hg commit</code> to shove changes from the working directory into&nbsp;the&nbsp;repository:</p>
<p><img alt="Mercurial Basics Diagram" src="/media/images/blog/2010/08/mercurial-basics.png" title="Mercurial Basics" /></p>
<p>This model doesn&#8217;t give you as much flexibility in creating changesets as
git&#8217;s does. You can use the <a href="http://mercurial.selenic.com/wiki/RecordExtension">record extension</a> to get closer, but it&#8217;s still
not&nbsp;the&nbsp;same.</p>
<p>Let&#8217;s take a look at <span class="caps"><span class="caps">MQ</span></span> to see how it can give us everything git&#8217;s index does
<em>and&nbsp;more.</em></p>
<h2 id="using-mq-with-a-single-patch">Using <span class="caps"><span class="caps">MQ</span></span> with a&nbsp;Single&nbsp;Patch</h2>
<p>The most basic way to use <span class="caps"><span class="caps">MQ</span></span> is to create a single patch with <code>hg qnew NAME</code>.
You can make changes in your working directory and use <code>hg qrefresh</code> (or <code>hg
qrecord</code>) to put them into the patch. Once you&#8217;re done with your patch and
ready for it to become a commit you can run <code>hg qfinish</code>:</p>
<p><img alt="MQ with One Patch" src="/media/images/blog/2010/08/mq-one.png" title="MQ with One Patch" /></p>
<p>This looks a lot like the diagram of how git works, doesn&#8217;t it?  <span class="caps"><span class="caps">MQ</span></span> gives you an
&#8220;intermediate&#8221; area to put changes, similar to how git&#8217;s&nbsp;index&nbsp;works.</p>
<h2 id="using-mq-with-two-or-more-patches">Using <span class="caps"><span class="caps">MQ</span></span> with Two (or&nbsp;More)&nbsp;Patches</h2>
<p>This single &#8220;intermediate&#8221; area is where git stops.  For many workflows it&#8217;s
enough, but if you want more power <span class="caps"><span class="caps">MQ</span></span> has&nbsp;you&nbsp;covered.</p>
<p><span class="caps"><span class="caps">MQ</span></span> is called Mercurial <em>Queues</em> for a reason.  You can have more than one patch
in your queue, which means you can have multiple &#8220;intermediate&#8221; areas if you&nbsp;need&nbsp;them.</p>
<p>For example: say you&#8217;re adding a feature that requires some <span class="caps"><span class="caps">API</span></span> changes to your
project.  You&#8217;d like to commit the changes to the <span class="caps"><span class="caps">API</span></span> in one changeset, and the
changes to the interface in another changeset.  You can do this by creating two
patches with <code>hg qnew api-changes; hg qnew interface-changes</code>:</p>
<p><img alt="MQ with Two Patches" src="/media/images/blog/2010/08/mq-two.png" title="MQ with Two Patches" /></p>
<p>You can move back and forth between these patches with <code>hg qpop</code> and <code>hg
qpush</code>. If you&#8217;re working on the interface and realize you forgot to make
a necessary change to the <span class="caps"><span class="caps">API</span></span>&nbsp;you&nbsp;can:</p>
<ul>
<li><code>hg qpop</code> the <code>interface-changes</code> patch to get to the <code>api-changes</code> patch.</li>
<li>Make your <span class="caps"><span class="caps">API</span></span>&nbsp;changes.</li>
<li><code>hg qrefresh</code> to put those changes into the <code>api-changes</code> patch.</li>
<li><code>hg qpush</code> to get back to work on&nbsp;the&nbsp;interface.</li>
</ul>
<p>Using multiple patches is like having multiple git indexes to store related
changes until you&#8217;re ready to commit&nbsp;them&nbsp;permanently.</p>
<h2 id="multiple-patch-queues">Multiple&nbsp;Patch&nbsp;Queues</h2>
<p>What happens when you want to work on two features, each with two patches, at
the same time?  You <em>could</em> simply create four patches and let the second
feature live on top of the first, but there&#8217;s a&nbsp;better&nbsp;way.</p>
<p>Mercurial 1.6 (I think) added the <code>hg qqueue</code> command, which lets you create
<em>multiple</em> patch queues, each one living in its own directory. That means you
can create a separate queue (with its own set of patches) with <code>hg qqueue -c
NAME</code> for&nbsp;each&nbsp;feature:</p>
<p><img alt="MQ with Multiple Queues" src="/media/images/blog/2010/08/mq-multiple.png" title="MQ with Multiple Queues" /></p>
<p>You can switch patch queues with <code>hg qqueue NAME</code>.  This gives you multiple
sets of &#8220;intermediate&#8221; areas like git&#8217;s index to work with.  This is probably
not something you&#8217;ll need very often, but it&#8217;s there when you <em>do</em>&nbsp;need&nbsp;it.</p>
<p>You can see that <span class="caps"><span class="caps">MQ</span></span> is already quite a bit more flexible than git&#8217;s index, but
it has one more trick up&nbsp;its&nbsp;sleeve.</p>
<h2 id="versioned-patch-queues">Versioned&nbsp;Patch&nbsp;Queues</h2>
<p>Let me prefix this section by saying: &#8220;You might think you need to use versioned
patch queues, but you probably don&#8217;t.&#8221;  Versioned queues can be tricky to wrap
your head around, but once you understand them you&#8217;ll realize how powerful they&nbsp;can&nbsp;be.</p>
<p>Let&#8217;s pause a second to look at how <span class="caps"><span class="caps">MQ</span></span> actually stores&nbsp;its&nbsp;patches.</p>
<p>When you create a new patch with <code>hg qnew interface-changes</code> Mercurial will
create a <code>patches</code> folder inside the <code>.hg</code> folder of your project.  Your new
patch is stored in a file inside that folder (along with some other&nbsp;metadata&nbsp;files):</p>
<div class="codehilite"><pre>yourproject/
|
+-- .hg/
|   |
|   +-- patches/
|   |   |
|   |   +-- api-changes
|   |   +-- interface-changes
|   |   `-- ... other MQ-related files ...
|   |
|   `-- ... other Mercurial-related files ...
|
`-- ... your project&#39;s files ...
</pre></div>


<p>When you create a new patch queue with <code>hg qqueue -c some-feature</code> Mercurial
creates a completely separate <code>patches-some-feature</code> folder in <code>.hg</code>:</p>
<div class="codehilite"><pre>yourproject/
|
+-- .hg/
|   |
|   +-- patches/
|   |   |
|   |   +-- api-changes
|   |   +-- interface-changes
|   |   `-- ... other MQ-related files ...
|   |
|   +-- patches-some-feature/
|   |   |
|   |   +-- api-changes
|   |   +-- interface-changes
|   |   `-- ... other MQ-related files ...
|   |
|   `-- ... other mercurial-related files ...
|
`-- ... your project&#39;s files ...
</pre></div>


<p>These folders are normal filesystem folders. The patches inside them are&nbsp;plain-text&nbsp;files.</p>
<p>This gives them a very&nbsp;important&nbsp;property:</p>
<p><strong>They can be turned into Mercurial repositories to&nbsp;track&nbsp;changes.</strong></p>
<p>Once you understand what this means, you should have several &#8220;oh my god&#8221;
moments where you realize several very&nbsp;interesting&nbsp;things:</p>
<ul>
<li>Not only can you have multiple sets of &#8220;intermediate&#8221; areas to work with, you
  can <em>version</em> them to keep track of&nbsp;the&nbsp;changes!</li>
<li>You can share queues with other people with Mercurial&#8217;s vanilla&nbsp;push/pull&nbsp;commands.</li>
<li>You can collaborate with other people and merge your changes to these
  &#8220;intermediate&#8221; areas with Mercurial&#8217;s vanilla&nbsp;push/pull/merge&nbsp;commands.</li>
<li>You can <code>hg serve</code> these patch repositories so other people can see what your
  patches look like before they&#8217;ve been permanently committed to your&nbsp;project&#8217;s&nbsp;repository.</li>
</ul>
<p>Versioning patch queues means you can end up with a (hard to read) diagram&nbsp;like&nbsp;this:</p>
<p><img alt="Versioned Queues" src="/media/images/blog/2010/08/mq-versioned.png" title="Versioned Queues" /></p>
<p>To facilitate working with versioned patch queues all Mercurial commands come
with a <code>--mq</code> option to apply the command to the queue repository instead of
the current one (so you don&#8217;t need to <code>cd</code> to the queue repository all&nbsp;the&nbsp;time).</p>
<p>Versioning patch queues is an <em>incredibly</em> powerful concept, and most of the
time you won&#8217;t need it, but it&#8217;s nice to have it when&nbsp;you&nbsp;do.</p>
<p>It&#8217;s also nice to know that <a href="http://bitbucket.org/">BitBucket</a> has <a href="http://ches.nausicaamedia.com/articles/technogeekery/using-mercurial-queues-and-bitbucket-org">special support</a> for version&nbsp;patch&nbsp;queues.</p>
<h2 id="problems-with-mq">Problems with&nbsp;<span class="caps"><span class="caps">MQ</span></span></h2>
<p>Despite how powerful <span class="caps"><span class="caps">MQ</span></span> is (or perhaps <em>because</em> of it) it has some problems.
Most could be fixed if someone had a week or two to spend on it, but so far no
one has&nbsp;stepped&nbsp;up.</p>
<p>I&#8217;d do it if I could afford to take a week away from full-time/freelance work,
but I can&#8217;t right now.  If you want to be the hero of at least one <span class="caps"><span class="caps">MQ</span></span> user (me)
here&#8217;s what sucks about&nbsp;<span class="caps"><span class="caps">MQ</span></span>:</p>
<ul>
<li>There&#8217;s no easy way to pull changes <em>out</em> of an <span class="caps"><span class="caps">MQ</span></span>&nbsp;patch.</li>
<li>There&#8217;s no easy way to split an <span class="caps"><span class="caps">MQ</span></span> patch into two patches (the current
  horrible &#8220;workaround&#8221; is to empty the current patch, <code>hg qrecord</code> part one,
  and <code>hg qnew</code> to make a new patch with&nbsp;part&nbsp;two).</li>
<li>You can&#8217;t pop a patch once you&#8217;ve made changes in your working directory. You
  need to <a href="http://mercurial.selenic.com/wiki/ShelveExtension">shelve</a> the changes, pop the patch, and then unshelve&nbsp;the&nbsp;changes.</li>
</ul>
<p>In addition there&#8217;s another <span class="caps"><span class="caps">MQ</span></span>-related change that would be very,&nbsp;very&nbsp;nice:</p>
<ul>
<li>Refactor the record extension and put it into core Mercurial, so that
  <code>hg qrecord</code> could be used without an extra extension (and we could have <code>hg
  commit --interactive</code>).</li>
</ul>
<p>If someone takes the time to fix these problems I&#8217;ll love them forever.  Until
then we&#8217;re stuck with the powerful-but-sometimes-clumsy <span class="caps"><span class="caps">MQ</span></span>&nbsp;interface.</p>
<p>Hopefully this post has given git users (and Mercurial users) an idea of how
powerful <span class="caps"><span class="caps">MQ</span></span> can be.  If you have any questions please find me on
<a href="http://twitter.com/stevelosh/">Twitter</a> and&nbsp;me&nbsp;know!</p>
                
            <!-- Hyde::Article::End -->
        
    </div>

                    
                
            </div>

            <div class="hrb">&nbsp;</div>

            <footer>
                I'm also on
                <a href="http://bitbucket.org/sjl/">BitBucket</a>,
                <a href="http://github.com/sjl/">GitHub</a>,
                <a href="http://twitter.com/stevelosh/">Twitter</a>,
                <a href="http://forrst.com/people/stevelosh/">Forrst</a>
                and
                <a href="http://flickr.com/photos/sjl7678/">Flickr</a>.
                I've got <a href="#" class="rhythm">rhythm</a>.
            </footer>
        </div>
    </body>

    <script type="text/javascript">
        var _gauges = _gauges || [];
        (function() {
         var t   = document.createElement('script');
         t.type  = 'text/javascript';
         t.async = true;
         t.id    = 'gauges-tracker';
         t.setAttribute('data-site-id', '4e8f83a7f5a1f53f20000011');
         t.src = '//secure.gaug.es/track.js';
         var s = document.getElementsByTagName('script')[0];
         s.parentNode.insertBefore(t, s);
         })();
     </script>
</html>
