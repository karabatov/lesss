    
<!DOCTYPE html>
<html>
    <head>
        <link href='http://fonts.googleapis.com/css?family=OFL+Sorts+Mill+Goudy+TT:regular,italic' rel='stylesheet' type='text/css' />
        <link rel="profile" href="http://microformats.org/profile/hcard" />
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />

        <title>Django Advice / Steve Losh</title>

        
            <link href="http://feeds2.feedburner.com/stevelosh"
                  rel="alternate" title="Steve Losh"
                  type="application/atom+xml" />
        

        
            <link rel="stylesheet" href="/media/css/aal.css"      type="text/css" media="screen" charset="utf-8" />
            <link rel="stylesheet" href="/media/css/sjl.css"      type="text/css" media="screen" charset="utf-8" />
            <link rel="stylesheet" href="/media/css/print.css"    type="text/css" media="print" charset="utf-8" />
            
    <link rel="stylesheet"
          href="/media/css/pygments-monokai-light.css"
          type="text/css" media="screen" charset="utf-8" />

        

        
            <script src="/media/js/jquery.js" type="text/javascript"></script>
            <script src="/media/js/jquery.timeago.js" type="text/javascript"></script>
            <script src="/media/js/sjl.js" type="text/javascript"></script>
            <script src="/media/js/print.js" type="text/javascript"></script>

            <script type="text/javascript">
                $(function() {
                    $("a.rhythm").toggle(function() {
                        $("body").addClass("rhythm");
                    }, function() {
                        $("body").removeClass("rhythm");
                    });
                });
            </script>

            <script type="text/javascript">
            /* <![CDATA[ */
                (function() {
                    var s = document.createElement('script'), t = document.getElementsByTagName('script')[0];

                    s.type = 'text/javascript';
                    s.async = true;
                    s.src = 'http://api.flattr.com/js/0.5.0/load.js?mode=auto';

                    t.parentNode.insertBefore(s, t);
                })();
            /* ]]> */
            </script>

            
        

        <link rel="openid.server" href="http://www.myopenid.com/server" />
        <link rel="openid.delegate" href="http://stevelosh.myopenid.com/" />

        <script type="text/javascript">
          var _gaq = _gaq || [];
          _gaq.push(['_setAccount', 'UA-15328874-2']);
          _gaq.push(['_trackPageview']);

          (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
          })();
        </script>

    </head>

    <body>
        <div class="wrap">
            <div class="top group">
                <header>
                    <a href="/">steve losh</a>
                </header>

                <nav>
                    <a href="/blog/">Blog</a>
                    <span class="sep">-</span>
                    <a href="/projects">Projects</a>
                    <span class="sep">-</span>
                    <a href="/about/">About</a>
                    <span class="sep">-</span>
                    <a href="http://feeds2.feedburner.com/stevelosh">Feed</a>
                </nav>
            </div>

            <div class="hr">&nbsp;</div>

            <div class="content">
                
                    
                        
    <div id="leaf-title">
        <h1><a href="/blog/2011/06/django-advice/">Django&nbsp;Advice</a></h1>
    </div>


    <div id="leaf-stats" class="group">
        
            <div class="flattr">
                <a class="FlattrButton" style="display:none;" rev="flattr;button:compact;"
                   href="http://stevelosh.com/blog/2011/06/django-advice/"></a>
           </div>
        
        <p>
            Posted
            <span class="timeago"
                  title="2011-06-30T08:30:00">
            </span>
            on June 30, 2011.
        </p>
    </div>

    <div id="leaf-content" class="">
        
            <!-- Hyde::Article::Begin -->
                
                    <p>For the past year and a half or so I&#8217;ve been working full-time at <a href="http://dwaiter.com/">Dumbwaiter
Design</a> doing <a href="http://www.djangoproject.com/">Django</a> development. I&#8217;ve picked up a bunch of useful tricks along
the way that help me work, and I figured I&#8217;d&nbsp;share&nbsp;them.</p>
<p>I&#8217;m sure there are better ways to do some of the things that I mention.  If you know
of any feel free to hit me up on <a href="http://twitter.com/stevelosh">Twitter</a> and let&nbsp;me&nbsp;know.</p>
<p>Also: this entry was written over several months, so if there are inconsistencies let
me know and I&#8217;ll try to&nbsp;fix&nbsp;them.</p>
<div class="toc">
<ul>
<li><a href="#vagrant">Vagrant</a><ul>
<li><a href="#why-vagrant">Why&nbsp;Vagrant?</a></li>
<li><a href="#using-fabric-to-stay-fast-and-automate-everything">Using Fabric to Stay Fast and&nbsp;Automate&nbsp;Everything</a></li>
</ul>
</li>
<li><a href="#wrangling-databases-with-south">Wrangling Databases with South</a><ul>
<li><a href="#useful-fabric-tasks">Useful&nbsp;Fabric&nbsp;Tasks</a></li>
</ul>
</li>
<li><a href="#watching-for-changes">Watching for Changes</a><ul>
<li><a href="#using-the-werkzeug-debugger-with-gunicorn">Using the Werkzeug Debugger&nbsp;with&nbsp;Gunicorn</a></li>
<li><a href="#pulling-uploads">Pulling&nbsp;Uploads</a></li>
<li><a href="#preventing-accidents">Preventing&nbsp;Accidents</a></li>
</ul>
</li>
<li><a href="#working-with-third-party-apps">Working with Third-Party Apps</a><ul>
<li><a href="#installing-apps-from-repositories">Installing Apps&nbsp;from&nbsp;Repositories</a></li>
<li><a href="#mirroring-repositories">Mirroring&nbsp;Repositories</a></li>
<li><a href="#using-bcvi-to-edit-files">Using <span class="caps"><span class="caps">BCVI</span></span> to&nbsp;Edit&nbsp;Files</a></li>
</ul>
</li>
<li><a href="#improving-the-admin-interface">Improving the Admin Interface</a><ul>
<li><a href="#enter-grappelli">Enter&nbsp;Grappelli</a></li>
<li><a href="#an-ugly-hack-to-show-usable-foreign-key-fields">An Ugly Hack to Show Usable Foreign&nbsp;Key&nbsp;Fields</a></li>
</ul>
</li>
<li><a href="#using-django-annoying">Using Django-Annoying</a><ul>
<li><a href="#the-render95to-decorator">The&nbsp;render_to&nbsp;Decorator</a></li>
<li><a href="#the-ajax95request-decorator">The&nbsp;ajax_request&nbsp;Decorator</a></li>
</ul>
</li>
<li><a href="#templating-tricks">Templating Tricks</a><ul>
<li><a href="#null-checks-and-fallbacks">Null Checks&nbsp;and&nbsp;Fallbacks</a></li>
<li><a href="#manipulating-query-strings">Manipulating&nbsp;Query&nbsp;Strings</a></li>
<li><a href="#satisfying-your-designer-with-typogrify">Satisfying Your Designer&nbsp;with&nbsp;Typogrify</a></li>
</ul>
</li>
<li><a href="#the-flat-page-trainwreck">The Flat&nbsp;Page&nbsp;Trainwreck</a></li>
<li><a href="#editing-with-vim">Editing with Vim</a><ul>
<li><a href="#vim-for-django">Vim&nbsp;for&nbsp;Django</a></li>
<li><a href="#filetype-mappings">Filetype&nbsp;Mappings</a></li>
<li><a href="#python-sanity-checking">Python&nbsp;Sanity&nbsp;Checking</a></li>
<li><a href="#javascript-sanity-checking-and-folding">Javascript Sanity Checking&nbsp;and&nbsp;Folding</a></li>
<li><a href="#django-autocommands">Django&nbsp;Autocommands</a></li>
</ul>
</li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
</div>
<h2 id="vagrant">Vagrant</h2>
<p>I used to develop Django sites by running them on my <span class="caps"><span class="caps">OS</span></span> X laptop locally and
deploying to a Linode <span class="caps"><span class="caps">VPS</span></span>.  I had a whole section of this post written up about
tricks and tips for working with&nbsp;that&nbsp;setup.</p>
<p>Then I found <a href="http://vagrantup.com/">Vagrant</a>.</p>
<p>I just deleted the entire section of this post&nbsp;I&nbsp;wrote.</p>
<p>Vagrant gives you a better way of working.  You need to&nbsp;use&nbsp;it.</p>
<h3 id="why-vagrant">Why&nbsp;Vagrant?</h3>
<p>If you haven&#8217;t used it before, Vagrant is basically a tool for managing
<a href="http://www.virtualbox.org/">VirtualBox</a> VMs.  It makes it easy to start, pause, and resume VMs.  Instead of
installing Django in a virtualenv and developing against that, you run a <span class="caps"><span class="caps">VM</span></span> which
runs your site and develop&nbsp;against&nbsp;that.</p>
<p>This may not sound like much, but it&#8217;s kind of a big deal.  The critical difference
is that you can now develop against the same setup that you&#8217;ll be using&nbsp;in&nbsp;production.</p>
<p>This cuts out a huge amount of pain that stems from <span class="caps"><span class="caps">OS</span></span> differences.  Here are a few
examples off the top of&nbsp;my&nbsp;head:</p>
<ul>
<li>URLField and MacPorts Python 2.5 on <span class="caps"><span class="caps">OS</span></span> X.  There&#8217;s a <a href="https://trac.macports.org/ticket/24421">bug</a> where using
  verify_exists will crash your site every time you save a model, unless you set
  a particular environment variable with no debug information.  Yeah, I spent
  a couple of hours tracking that one down at&nbsp;work.&nbsp;Awesome.</li>
<li>Installing <span class="caps"><span class="caps">PIL</span></span> on <span class="caps"><span class="caps">OS</span></span> X is no picnic.  <a href="http://mxcl.github.com/homebrew/">homebrew</a> makes things better, if you use it,
  so this one isn&#8217;t a&nbsp;huge&nbsp;deal.</li>
<li>Every time you update Python in-place on your local machines, <span class="caps"><span class="caps">ALL</span></span> of your
  virtualenvs break because the Python binaries inside are linked against global
  Python library files.  Have fun recreating them.  I hope you froze your
  <code>requirements.txt</code> files before&nbsp;you&nbsp;updated.</li>
</ul>
<p>Using Vagrant and VMs means you can just worry about <span class="caps"><span class="caps">ONE</span></span> operating system and its
quirks.  It saves you a ton&nbsp;of&nbsp;time.</p>
<p>Aside from that, there&#8217;s another benefit to using Vagrant: it strongly encourages you
to learn and use an automated provisioning system.  Support for Puppet and Chef is
built in.  I chose Puppet, but if you prefer Chef that&#8217;s&nbsp;cool&nbsp;too.</p>
<p>You can also use other tools like Fabric or some simple scripts, but I&#8217;d strongly
recommend giving Puppet or Chef a fair shot.  It&#8217;s a lot to learn, but they&#8217;re both
widely tested and&nbsp;very&nbsp;powerful.</p>
<p>Because you&#8217;re developing against a <span class="caps"><span class="caps">VM</span></span> and deploying to a <span class="caps"><span class="caps">VM</span></span>, you can reuse 90% of
the provisioning code across&nbsp;the&nbsp;two.</p>
<p>When I make a new site, I do the following to initialize a new Vagrant&nbsp;<span class="caps"><span class="caps">VM</span></span>:</p>
<ol>
<li><code>vagrant up</code> (which runs Puppet to initialize the&nbsp;<span class="caps"><span class="caps">VM</span></span>)</li>
<li><code>fab dev bootstrap</code></li>
</ol>
<p>When I&#8217;m ready to go live, I do&nbsp;the&nbsp;following:</p>
<ol>
<li>Buy a Linode&nbsp;<span class="caps"><span class="caps">VPS</span></span>.</li>
<li>Run Puppet to initialize the&nbsp;<span class="caps"><span class="caps">VPS</span></span>.</li>
<li>Enter the Linode info in&nbsp;my&nbsp;fabfile.</li>
<li><code>fab prod bootstrap</code></li>
</ol>
<p>No more screwing around with different paths, different versions of Nginx, different
versions of Python.  When I&#8217;m developing something I can be pretty confident it will
&#8220;just work&#8221; in production without any&nbsp;major&nbsp;surprises.</p>
<h3 id="using-fabric-to-stay-fast-and-automate-everything">Using Fabric to Stay Fast and&nbsp;Automate&nbsp;Everything</h3>
<p>One of the problems with this setup is that I can&#8217;t just run <code>python manage.py
whatever</code> any more because I need it to run on the&nbsp;<span class="caps"><span class="caps">VM</span></span>.</p>
<p>To get around this I&#8217;ve created many simple <a href="http://fabfile.org/">Fabric</a> tasks to automate the common
things I need to do.  Fabric is an awesome little Python utility for scripting tasks
(like deployments).  We use it constantly at Dumbwaiter.  Here are a few examples
from&nbsp;our&nbsp;fabfiles.</p>
<p>This first set is for running abitrary&nbsp;commands&nbsp;easily.</p>
<p><code>cmd</code> and <code>vcmd</code> will <code>cd</code> into the site directory on the <span class="caps"><span class="caps">VM</span></span> and run a command of my
choosing.  <code>vcmd</code> will prefix the command with the path to the virtualenv&#8217;s <code>bin</code>
directory, so I can do something like <code>fab dev vcmd</code>, <code>pip install markdown</code>.</p>
<p>The <code>sdo</code> commands do the same thing, but <code>sudo</code>&#8216;ed.</p>
<div class="codehilite"><pre><span class="k">def</span> <span class="nf">cmd</span><span class="p">(</span><span class="n">cmd</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Run a command in the site directory.  Usable from other commands or the <span class="caps"><span class="caps">CLI</span></span>.&#39;&#39;&#39;</span>
    <span class="n">require</span><span class="p">(</span><span class="s">&#39;site_path&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">cmd</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">_cyan</span><span class="p">(</span><span class="s">&quot;Command to run: &quot;</span><span class="p">))</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">cmd</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">cd</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">site_path</span><span class="p">):</span>
            <span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">sdo</span><span class="p">(</span><span class="n">cmd</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Sudo a command in the site directory.  Usable from other commands or the <span class="caps"><span class="caps">CLI</span></span>.&#39;&#39;&#39;</span>
    <span class="n">require</span><span class="p">(</span><span class="s">&#39;site_path&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">cmd</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">_cyan</span><span class="p">(</span><span class="s">&quot;Command to run: sudo &quot;</span><span class="p">))</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">cmd</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">cd</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">site_path</span><span class="p">):</span>
            <span class="n">sudo</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">vcmd</span><span class="p">(</span><span class="n">cmd</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Run a virtualenv-based command in the site directory.  Usable from other commands or the <span class="caps"><span class="caps">CLI</span></span>.&#39;&#39;&#39;</span>
    <span class="n">require</span><span class="p">(</span><span class="s">&#39;site_path&#39;</span><span class="p">)</span>
    <span class="n">require</span><span class="p">(</span><span class="s">&#39;venv_path&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">cmd</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">_cyan</span><span class="p">(</span><span class="s">&quot;Command to run: </span><span class="si">%s</span><span class="s">/bin/&quot;</span> <span class="o">%</span> <span class="n">env</span><span class="o">.</span><span class="n">venv_path</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)))</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">cmd</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">cd</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">site_path</span><span class="p">):</span>
            <span class="n">run</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">venv_path</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;/bin/&#39;</span> <span class="o">+</span> <span class="n">cmd</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">vsdo</span><span class="p">(</span><span class="n">cmd</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Sudo a virtualenv-based command in the site directory.  Usable from other commands or the <span class="caps"><span class="caps">CLI</span></span>.&#39;&#39;&#39;</span>
    <span class="n">require</span><span class="p">(</span><span class="s">&#39;site_path&#39;</span><span class="p">)</span>
    <span class="n">require</span><span class="p">(</span><span class="s">&#39;venv_path&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">cmd</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">_cyan</span><span class="p">(</span><span class="s">&quot;Command to run: sudo </span><span class="si">%s</span><span class="s">/bin/&quot;</span> <span class="o">%</span> <span class="n">env</span><span class="o">.</span><span class="n">venv_path</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)))</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">cmd</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">cd</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">site_path</span><span class="p">):</span>
            <span class="n">sudo</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">venv_path</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;/bin/&#39;</span> <span class="o">+</span> <span class="n">cmd</span><span class="p">)</span>
</pre></div>


<p>This next set is just some common commands that I need to&nbsp;run&nbsp;often.</p>
<div class="codehilite"><pre><span class="k">def</span> <span class="nf">syncdb</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Run syncdb.&#39;&#39;&#39;</span>
    <span class="n">require</span><span class="p">(</span><span class="s">&#39;site_path&#39;</span><span class="p">)</span>
    <span class="n">require</span><span class="p">(</span><span class="s">&#39;venv_path&#39;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">cd</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">site_path</span><span class="p">):</span>
        <span class="n">run</span><span class="p">(</span><span class="n">_python</span><span class="p">(</span><span class="s">&#39;manage.py syncdb --noinput&#39;</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">collectstatic</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Collect static media.&#39;&#39;&#39;</span>
    <span class="n">require</span><span class="p">(</span><span class="s">&#39;site_path&#39;</span><span class="p">)</span>
    <span class="n">require</span><span class="p">(</span><span class="s">&#39;venv_path&#39;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">cd</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">site_path</span><span class="p">):</span>
        <span class="n">sudo</span><span class="p">(</span><span class="n">_python</span><span class="p">(</span><span class="s">&#39;manage.py collectstatic --noinput&#39;</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">rebuild_index</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Rebuild the search index.&#39;&#39;&#39;</span>
    <span class="n">require</span><span class="p">(</span><span class="s">&#39;site_path&#39;</span><span class="p">)</span>
    <span class="n">require</span><span class="p">(</span><span class="s">&#39;venv_path&#39;</span><span class="p">)</span>
    <span class="n">require</span><span class="p">(</span><span class="s">&#39;process_owner&#39;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">cd</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">site_path</span><span class="p">):</span>
        <span class="n">sudo</span><span class="p">(</span><span class="n">_python</span><span class="p">(</span><span class="s">&#39;manage.py rebuild_index&#39;</span><span class="p">))</span>
        <span class="n">sudo</span><span class="p">(</span><span class="s">&#39;chown -R </span><span class="si">%s</span><span class="s"> .xapian&#39;</span> <span class="o">%</span> <span class="n">env</span><span class="o">.</span><span class="n">process_owner</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">update_index</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Update the search index.&#39;&#39;&#39;</span>
    <span class="n">require</span><span class="p">(</span><span class="s">&#39;site_path&#39;</span><span class="p">)</span>
    <span class="n">require</span><span class="p">(</span><span class="s">&#39;venv_path&#39;</span><span class="p">)</span>
    <span class="n">require</span><span class="p">(</span><span class="s">&#39;process_owner&#39;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">cd</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">site_path</span><span class="p">):</span>
        <span class="n">sudo</span><span class="p">(</span><span class="n">_python</span><span class="p">(</span><span class="s">&#39;manage.py update_index&#39;</span><span class="p">))</span>
        <span class="n">sudo</span><span class="p">(</span><span class="s">&#39;chown -R </span><span class="si">%s</span><span class="s"> .xapian&#39;</span> <span class="o">%</span> <span class="n">env</span><span class="o">.</span><span class="n">process_owner</span><span class="p">)</span>
</pre></div>


<p>We also use Fabric to automate some of the more complex things we need&nbsp;to&nbsp;do.</p>
<p>This task <code>curl</code>&#8216;s the site&#8217;s home page to make sure we haven&#8217;t completely borked
things.  We use it in lots of other tasks as a&nbsp;sanity&nbsp;check.</p>
<div class="codehilite"><pre><span class="k">def</span> <span class="nf">check</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Check that the home page of the site returns an <span class="caps"><span class="caps">HTTP</span></span> 200.&#39;&#39;&#39;</span>
    <span class="n">require</span><span class="p">(</span><span class="s">&#39;site_url&#39;</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Checking site status...&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="s">&#39;200 <span class="caps"><span class="caps">OK</span></span>&#39;</span> <span class="ow">in</span> <span class="n">local</span><span class="p">(</span><span class="s">&#39;curl --silent -I &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">env</span><span class="o">.</span><span class="n">site_url</span><span class="p">,</span> <span class="n">capture</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">_sad</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_happy</span><span class="p">()</span>
</pre></div>


<p>The <code>_happy</code> and <code>_sad</code> functions just print out some simple messages to get&nbsp;our&nbsp;attention:</p>
<div class="codehilite"><pre><span class="kn">from</span> <span class="nn">fabric.colors</span> <span class="kn">import</span> <span class="n">red</span><span class="p">,</span> <span class="n">green</span>

<span class="k">def</span> <span class="nf">_happy</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="n">green</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Looks good from here!</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_sad</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="n">red</span><span class="p">(</span><span class="s">r&#39;&#39;&#39;</span>
<span class="s">          ___           ___</span>
<span class="s">         /  /\         /__/\</span>
<span class="s">        /  /::\        \  \:\</span>
<span class="s">       /  /:/\:\        \__\:\</span>
<span class="s">      /  /:/  \:\   ___ /  /::\</span>
<span class="s">     /__/:/ \__\:\ /__/\  /:/\:\</span>
<span class="s">     \  \:\ /  /:/ \  \:\/:/__\/</span>
<span class="s">      \  \:\  /:/   \  \::/</span>
<span class="s">       \  \:\/:/     \  \:\</span>
<span class="s">        \  \::/       \  \:\</span>
<span class="s">         \__\/         \__\/</span>
<span class="s">          ___           ___           ___           ___</span>
<span class="s">         /__/\         /  /\         /  /\         /  /\     ___</span>
<span class="s">         \  \:\       /  /::\       /  /:/_       /  /:/_   /__/\</span>
<span class="s">          \  \:\     /  /:/\:\     /  /:/ /\     /  /:/ /\  \  \:\</span>
<span class="s">      _____\__\:\   /  /:/  \:\   /  /:/ /:/_   /  /:/ /::\  \  \:\</span>
<span class="s">     /__/::::::::\ /__/:/ \__\:\ /__/:/ /:/ /\ /__/:/ /:/\:\  \  \:\</span>
<span class="s">     \  \:\~~\~~\/ \  \:\ /  /:/ \  \:\/:/ /:/ \  \:\/:/~/:/   \  \:\</span>
<span class="s">      \  \:\  ~~~   \  \:\  /:/   \  \::/ /:/   \  \::/ /:/     \__\/</span>
<span class="s">       \  \:\        \  \:\/:/     \  \:\/:/     \__\/ /:/          __</span>
<span class="s">        \  \:\        \  \::/       \  \::/        /__/:/          /__/\</span>
<span class="s">         \__\/         \__\/         \__\/         \__\/           \__\/</span>

<span class="s">         Something seems to have gone wrong!</span>
<span class="s">         You should probably take a look at that.</span>
<span class="s">    &#39;&#39;&#39;</span><span class="p">))</span>
</pre></div>


<p>This one is for when <code>python manage.py reset APP</code> is broken because you&#8217;ve changed
some <code>db_column</code> names and Django chokes because of some constraits and you just want
to <strong>reset the fucking app</strong>.</p>
<p>It&#8217;s the &#8220;<span class="caps"><span class="caps">NUKE</span></span> <span class="caps"><span class="caps">IT</span></span> <span class="caps"><span class="caps">FROM</span></span> <span class="caps"><span class="caps">ORBIT</span></span>!!&#8221;&nbsp;option.</p>
<div class="codehilite"><pre><span class="k">def</span> <span class="nf">KILL_IT_WITH_FIRE</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
    <span class="n">require</span><span class="p">(</span><span class="s">&#39;site_path&#39;</span><span class="p">)</span>
    <span class="n">require</span><span class="p">(</span><span class="s">&#39;venv_path&#39;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">cd</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">site_path</span><span class="p">):</span>
        <span class="c"># Generate and download the reset <span class="caps"><span class="caps">SQL</span></span>.</span>
        <span class="n">sudo</span><span class="p">(</span><span class="n">_python</span><span class="p">(</span><span class="s">&#39;manage.py sqlreset </span><span class="si">%s</span><span class="s"> &gt; reset.orig.sql&#39;</span> <span class="o">%</span> <span class="n">app</span><span class="p">))</span>
        <span class="n">get</span><span class="p">(</span><span class="s">&#39;reset.orig.sql&#39;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;reset.sql&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;reset.orig.sql&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">orig</span><span class="p">:</span>
                <span class="c"># Step through the first chunk of the file (the &quot;drop&quot; part).</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">orig</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                <span class="k">while</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;<span class="caps"><span class="caps">CREATE</span></span>&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="s">&#39;<span class="caps"><span class="caps">CONSTRAINT</span></span>&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="c"># Don&#39;t write out <span class="caps"><span class="caps">CONSTRAINT</span></span> lines.</span>
                        <span class="c"># They&#39;re a problem when you change db_colum names.</span>
                        <span class="k">pass</span>
                    <span class="k">elif</span> <span class="s">&#39;<span class="caps"><span class="caps">DROP</span></span> <span class="caps"><span class="caps">TABLE</span></span>&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="c"># Cascade drops.</span>
                        <span class="c"># Hence with &quot;with fire&quot; part of this task&#39;s name.</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39; <span class="caps"><span class="caps">CASCADE</span></span>;</span><span class="se">\n</span><span class="s">&#39;</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c"># Write other lines through untoched.</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">orig</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

                <span class="c"># Write out the rest of the file untouched.</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">orig</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

    <span class="c"># Upload the processed <span class="caps"><span class="caps">SQL</span></span> file.</span>
    <span class="n">put</span><span class="p">(</span><span class="s">&#39;reset.sql&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">site_path</span><span class="p">,</span> <span class="s">&#39;reset.ready.sql&#39;</span><span class="p">),</span> <span class="n">use_sudo</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">cd</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">site_path</span><span class="p">):</span>
        <span class="c"># Use the <span class="caps"><span class="caps">SQL</span></span> to reset the app, and fake a migration.</span>
        <span class="n">run</span><span class="p">(</span><span class="n">_python</span><span class="p">(</span><span class="s">&#39;manage.py dbshell &lt; reset.ready.sql&#39;</span><span class="p">))</span>
        <span class="n">sudo</span><span class="p">(</span><span class="n">_python</span><span class="p">(</span><span class="s">&#39;manage.py migrate --fake --delete-ghost-migrations &#39;</span> <span class="o">+</span> <span class="n">app</span><span class="p">))</span>
</pre></div>


<p>This task uses Mercurial&#8217;s local tags to add a <code>production</code> or <code>staging</code> tag in your local
repository, so you can easy see where the production/staging servers are at
compared to your&nbsp;local&nbsp;repo.</p>
<div class="codehilite"><pre><span class="k">def</span> <span class="nf">retag</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Check which revision the site is at and update the local tag.</span>

<span class="sd">    Useful if someone else has deployed (which makes your production/staging local</span>
<span class="sd">    tag incorrect.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">require</span><span class="p">(</span><span class="s">&#39;site_path&#39;</span><span class="p">,</span> <span class="n">provided_by</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;prod&#39;</span><span class="p">,</span> <span class="s">&#39;stag&#39;</span><span class="p">])</span>
    <span class="n">require</span><span class="p">(</span><span class="s">&#39;env_name&#39;</span><span class="p">,</span> <span class="n">provided_by</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;prod&#39;</span><span class="p">,</span> <span class="s">&#39;stag&#39;</span><span class="p">])</span>

    <span class="k">with</span> <span class="n">cd</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">site_path</span><span class="p">):</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="s">&#39;hg id --rev . --quiet&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39; </span><span class="se">\n</span><span class="s">+&#39;</span><span class="p">)</span>

    <span class="n">local</span><span class="p">(</span><span class="s">&#39;hg tag --local --force </span><span class="si">%s</span><span class="s"> --rev </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">env_name</span><span class="p">,</span> <span class="n">current</span><span class="p">))</span>
</pre></div>


<p>This task tails the Gunicorn logs on the server so you can quickly find out what&#8217;s
happening when things&nbsp;blow&nbsp;up.</p>
<div class="codehilite"><pre><span class="k">def</span> <span class="nf">tailgun</span><span class="p">(</span><span class="n">follow</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tail the Gunicorn log file.&quot;&quot;&quot;</span>
    <span class="n">require</span><span class="p">(</span><span class="s">&#39;site_path&#39;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">cd</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">site_path</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">follow</span><span class="p">:</span>
            <span class="n">run</span><span class="p">(</span><span class="s">&#39;tail -f .gunicorn.log&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">run</span><span class="p">(</span><span class="s">&#39;tail .gunicorn.log&#39;</span><span class="p">)</span>
</pre></div>


<p>We&#8217;ve got a lot of other tasks but they&#8217;re pretty specific to&nbsp;our&nbsp;setup.</p>
<h2 id="wrangling-databases-with-south">Wrangling Databases&nbsp;with&nbsp;South</h2>
<p>If you&#8217;re not using <a href="http://south.aeracode.org/">South</a>, you need to&nbsp;start.&nbsp;Now.</p>
<p>No, really, I&#8217;ll wait.  Take 30 minutes, try the <a href="http://south.aeracode.org/docs/tutorial/index.html">tutorial</a>, wrap your head
around it and come back.  It&#8217;s far more important than this&nbsp;blog&nbsp;post.</p>
<h3 id="useful-fabric-tasks">Useful&nbsp;Fabric&nbsp;Tasks</h3>
<p>South is awesome but its commands are very long-winded.  Here&#8217;s the set of fabric
tasks I use to save quite a bit&nbsp;of&nbsp;typing:</p>
<div class="codehilite"><pre><span class="k">def</span> <span class="nf">migrate</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Run any needed migrations.&#39;&#39;&#39;</span>
    <span class="n">require</span><span class="p">(</span><span class="s">&#39;site_path&#39;</span><span class="p">)</span>
    <span class="n">require</span><span class="p">(</span><span class="s">&#39;venv_path&#39;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">cd</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">site_path</span><span class="p">):</span>
        <span class="n">sudo</span><span class="p">(</span><span class="n">_python</span><span class="p">(</span><span class="s">&#39;manage.py migrate &#39;</span> <span class="o">+</span> <span class="n">args</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">migrate_fake</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Run any needed migrations with --fake.&#39;&#39;&#39;</span>
    <span class="n">require</span><span class="p">(</span><span class="s">&#39;site_path&#39;</span><span class="p">)</span>
    <span class="n">require</span><span class="p">(</span><span class="s">&#39;venv_path&#39;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">cd</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">site_path</span><span class="p">):</span>
        <span class="n">sudo</span><span class="p">(</span><span class="n">_python</span><span class="p">(</span><span class="s">&#39;manage.py migrate --fake &#39;</span> <span class="o">+</span> <span class="n">args</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">migrate_reset</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Run any needed migrations with --fake.  No, seriously.&#39;&#39;&#39;</span>
    <span class="n">require</span><span class="p">(</span><span class="s">&#39;site_path&#39;</span><span class="p">)</span>
    <span class="n">require</span><span class="p">(</span><span class="s">&#39;venv_path&#39;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">cd</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">site_path</span><span class="p">):</span>
        <span class="n">sudo</span><span class="p">(</span><span class="n">_python</span><span class="p">(</span><span class="s">&#39;manage.py migrate --fake --delete-ghost-migrations &#39;</span> <span class="o">+</span> <span class="n">args</span><span class="p">))</span>
</pre></div>


<p>Remember that running a migration without specifying an app will migrate everything,
so a simple <code>fab dev migrate</code> will do&nbsp;the&nbsp;trick.</p>
<h2 id="watching-for-changes">Watching&nbsp;for&nbsp;Changes</h2>
<p>When developing locally you&#8217;ll want to make a change to your code and have the server
reload that code automatically.  The Django development server does this, and we can
hack it into our Vagrant/Gunicorn&nbsp;setup&nbsp;too.</p>
<p>First, add a <code>monitor.py</code> file at the root of your project (I believe I found this
code <a href="http://code.google.com/p/modwsgi/wiki/ReloadingSourceCode">here</a>, but I may&nbsp;be&nbsp;wrong):</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">atexit</span>
<span class="kn">import</span> <span class="nn">Queue</span>

<span class="n">_interval</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">_times</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">_files</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">_running</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
<span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_restart</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="s">&#39;monitor (pid=</span><span class="si">%d</span><span class="s">):&#39;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
    <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> Change detected to </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
    <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> Triggering process restart.&#39;</span> <span class="o">%</span> <span class="n">prefix</span>
    <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span> <span class="n">signal</span><span class="o">.</span><span class="n"><span class="caps"><span class="caps">SIGINT</span></span></span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_modified</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c"># If path doesn&#39;t denote a file and were previously</span>
        <span class="c"># tracking it, then it has been removed or the file type</span>
        <span class="c"># has changed so force a restart. If not previously</span>
        <span class="c"># tracking the file then we can ignore it as probably</span>
        <span class="c"># pseudo reference such as when file extracted from a</span>
        <span class="c"># collection of modules contained in a zip file.</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">_times</span>

        <span class="c"># Check for when file last modified.</span>

        <span class="n">mtime</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">st_mtime</span>
        <span class="k">if</span> <span class="n">path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_times</span><span class="p">:</span>
            <span class="n">_times</span><span class="p">[</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="n">mtime</span>

        <span class="c"># Force restart when modification time has changed, even</span>
        <span class="c"># if time now older, as that could indicate older file</span>
        <span class="c"># has been restored.</span>

        <span class="k">if</span> <span class="n">mtime</span> <span class="o">!=</span> <span class="n">_times</span><span class="p">[</span><span class="n">path</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">True</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="c"># If any exception occured, likely that file has been</span>
        <span class="c"># been removed just before stat(), so force a restart.</span>

        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">return</span> <span class="bp">False</span>

<span class="k">def</span> <span class="nf">_monitor</span><span class="p">():</span>
    <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c"># Check modification times on all files in sys.modules.</span>

        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s">&#39;__file__&#39;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">path</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s">&#39;__file__&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;.pyc&#39;</span><span class="p">,</span> <span class="s">&#39;.pyo&#39;</span><span class="p">,</span> <span class="s">&#39;.pyd&#39;</span><span class="p">]:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">_modified</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">_restart</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="c"># Check modification times on files which have</span>
        <span class="c"># specifically been registered for monitoring.</span>

        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">_files</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_modified</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">_restart</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="c"># Go to sleep for specified interval.</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">_interval</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

<span class="n">_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">_monitor</span><span class="p">)</span>
<span class="n">_thread</span><span class="o">.</span><span class="n">setDaemon</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_exiting</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">_thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

<span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">_exiting</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">track</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">_files</span><span class="p">:</span>
        <span class="n">_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="n">interval</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">_interval</span>
    <span class="k">if</span> <span class="n">interval</span> <span class="o">&lt;</span> <span class="n">_interval</span><span class="p">:</span>
        <span class="n">_interval</span> <span class="o">=</span> <span class="n">interval</span>

    <span class="k">global</span> <span class="n">_running</span>
    <span class="n">_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_running</span><span class="p">:</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="s">&#39;monitor (pid=</span><span class="si">%d</span><span class="s">):&#39;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> Starting change monitor.&#39;</span> <span class="o">%</span> <span class="n">prefix</span>
        <span class="n">_running</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</pre></div>


<p>Next add a <code>post_fork</code> hook to your Gunicorn config file that uses the monitor to
watch&nbsp;for&nbsp;changes:</p>
<div class="codehilite"><pre><span class="k">def</span> <span class="nf">post_fork</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">worker</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">monitor</span>
    <span class="kn">import</span> <span class="nn">local_settings</span>
    <span class="k">if</span> <span class="n">local_settings</span><span class="o">.</span><span class="n"><span class="caps"><span class="caps">DEBUG</span></span></span><span class="p">:</span>
        <span class="n">server</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Starting change monitor.&quot;</span><span class="p">)</span>
        <span class="n">monitor</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">interval</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
</pre></div>


<p>Now the Gunicorn server will automatically restart whenever code is changed.  Use
whatever method for determining debug status that you like.  We use
<code>local_settings.py</code> files which all have <code>DEBUG</code> variables, so that works&nbsp;for&nbsp;us.</p>
<p>It will <em>not</em> restart when you add new code (e.g. when you install a new app), so
you&#8217;ll need to handle that manually with <code>fab dev restart</code>, but that&#8217;s not&nbsp;too&nbsp;bad!</p>
<h3 id="using-the-werkzeug-debugger-with-gunicorn">Using the Werkzeug Debugger&nbsp;with&nbsp;Gunicorn</h3>
<p>The final piece of the puzzle is being able to use the fantastic <a href="http://werkzeug.pocoo.org/docs/debug/">Werkzeug
Debugger</a> while running on the development <span class="caps"><span class="caps">VM</span></span>&nbsp;with&nbsp;Gunicorn.</p>
<p>To do this, create a <code>debug_wsgi.py</code> file at the root of&nbsp;your&nbsp;project:</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">site</span>

<span class="n">parent</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span>
<span class="n">site_dir</span> <span class="o">=</span> <span class="n">parent</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>
<span class="n">project_dir</span> <span class="o">=</span> <span class="n">parent</span><span class="p">(</span><span class="n">parent</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">__file__</span><span class="p">)))</span>

<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">project_dir</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">site_dir</span><span class="p">)</span>

<span class="n">site</span><span class="o">.</span><span class="n">addsitedir</span><span class="p">(</span><span class="s">&#39;VIRTUALENV_SITE_PACKAGES&#39;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">django.core.management</span> <span class="kn">import</span> <span class="n">setup_environ</span>
<span class="kn">import</span> <span class="nn">settings</span>
<span class="n">setup_environ</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">django.core.handlers.wsgi</span>
<span class="n">application</span> <span class="o">=</span> <span class="n">django</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">wsgi</span><span class="o">.</span><span class="n">WSGIHandler</span><span class="p">()</span>

<span class="kn">from</span> <span class="nn">werkzeug.debug</span> <span class="kn">import</span> <span class="n">DebuggedApplication</span>
<span class="n">application</span> <span class="o">=</span> <span class="n">DebuggedApplication</span><span class="p">(</span><span class="n">application</span><span class="p">,</span> <span class="n">evalex</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">null_technical_500_response</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span>
    <span class="k">raise</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">tb</span>
<span class="kn">from</span> <span class="nn">django.views</span> <span class="kn">import</span> <span class="n">debug</span>
<span class="n">debug</span><span class="o">.</span><span class="n">technical_500_response</span> <span class="o">=</span> <span class="n">null_technical_500_response</span>
</pre></div>


<p>Have Gunicorn use this file to run your development server with <code>gunicorn
debug_wsgi:application</code>.</p>
<p>Make sure to replace <code>'VIRTUALENV_SITE_PACKAGES'</code> with the <em>full</em> path to your
virtualenv&#8217;s <code>site_packages</code> directory.  You might want to make this a setting in
a machine-specific&nbsp;settings&nbsp;file.</p>
<h3 id="pulling-uploads">Pulling&nbsp;Uploads</h3>
<p>Once you give a client access to a site they&#8217;ll probably be uploading images (through
Django&#8217;s built-in file uploading features or with <a href="http://code.google.com/p/django-filebrowser/">django-filebrowser</a>).</p>
<p>When you&#8217;re making changes locally it&#8217;s often useful to have these uploaded files on
your local <span class="caps"><span class="caps">VM</span></span>, otherwise you end up with a bunch of&nbsp;broken&nbsp;images.</p>
<p>Here&#8217;s a simple Fabric task that will pull down all the uploads from&nbsp;the&nbsp;server:</p>
<div class="codehilite"><pre><span class="k">def</span> <span class="nf">pull_uploads</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Copy the uploads from the site to your local machine.&#39;&#39;&#39;</span>
    <span class="n">require</span><span class="p">(</span><span class="s">&#39;uploads_path&#39;</span><span class="p">)</span>

    <span class="n">sudo</span><span class="p">(</span><span class="s">&#39;chmod -R a+r &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">env</span><span class="o">.</span><span class="n">uploads_path</span><span class="p">)</span>

    <span class="n">rsync_command</span> <span class="o">=</span> <span class="s">r&quot;&quot;&quot;rsync -av -e &#39;ssh -p </span><span class="si">%s</span><span class="s">&#39; </span><span class="si">%s</span><span class="s">@</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="n">env</span><span class="o">.</span><span class="n">port</span><span class="p">,</span>
        <span class="n">env</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
        <span class="n">env</span><span class="o">.</span><span class="n">uploads_path</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span><span class="p">,</span>
        <span class="s">&#39;media/uploads&#39;</span>
    <span class="p">)</span>
    <span class="k">print</span> <span class="n">local</span><span class="p">(</span><span class="n">rsync_command</span><span class="p">,</span> <span class="n">capture</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>


<p>You might be wondering about the line that strips <code>/</code> characters and then adds them
back in.  <code>rsync</code> does different things depending on whether you end a path with
a <code>/</code>, so this is actually&nbsp;pretty&nbsp;important.</p>
<p>In your host task you&#8217;ll need to set the <code>uploads_path</code> variable to something&nbsp;like&nbsp;this:</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">os</span>
<span class="n">env</span><span class="o">.</span><span class="n">site_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;var&#39;</span><span class="p">,</span> <span class="s">&#39;www&#39;</span><span class="p">,</span> <span class="s">&#39;myproject&#39;</span><span class="p">)</span>
<span class="n">env</span><span class="o">.</span><span class="n">uploads_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">site_path</span><span class="p">,</span> <span class="s">&#39;media&#39;</span><span class="p">,</span> <span class="s">&#39;uploads&#39;</span><span class="p">)</span>
</pre></div>


<p>Now you can run <code>fab production pull_uploads</code> to pull down all the files people have
uploaded to the&nbsp;production&nbsp;server.</p>
<h3 id="preventing-accidents">Preventing&nbsp;Accidents</h3>
<p>Deploying to test and staging servers should be quick and easy. Deploying to
production servers should be harder to prevent people from accidentally&nbsp;doing&nbsp;it.</p>
<p>I&#8217;ve created a little function that I call before deploying to production servers.
It forces me to type in random words from the system word list before proceeding to
make sure I <em>really</em> know what&nbsp;I&#8217;m&nbsp;doing:</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">random</span>

<span class="kn">from</span> <span class="nn">fabric.api</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">fabric.operations</span> <span class="kn">import</span> <span class="n">prompt</span>
<span class="kn">from</span> <span class="nn">fabric.utils</span> <span class="kn">import</span> <span class="n">abort</span>

<span class="n">WORDLIST_PATHS</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">,</span> <span class="s">&#39;usr&#39;</span><span class="p">,</span> <span class="s">&#39;share&#39;</span><span class="p">,</span> <span class="s">&#39;dict&#39;</span><span class="p">,</span> <span class="s">&#39;words&#39;</span><span class="p">)]</span>
<span class="n">DEFAULT_MESSAGE</span> <span class="o">=</span> <span class="s">&quot;Are you sure you want to do this?&quot;</span>
<span class="n">WORD_PROMPT</span> <span class="o">=</span> <span class="s">&#39;  [</span><span class="si">%d</span><span class="s">/</span><span class="si">%d</span><span class="s">] Type &quot;</span><span class="si">%s</span><span class="s">&quot; to continue (^C quits): &#39;</span>

<span class="k">def</span> <span class="nf">prevent_horrible_accidents</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="n">DEFAULT_MESSAGE</span><span class="p">,</span> <span class="n">horror_rating</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Prompt the user to enter random words to prevent doing something stupid.&quot;&quot;&quot;</span>

    <span class="n">valid_wordlist_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">wp</span> <span class="k">for</span> <span class="n">wp</span> <span class="ow">in</span> <span class="n">WORDLIST_PATHS</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">wp</span><span class="p">)]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_wordlist_paths</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="s">&#39;No wordlists found!&#39;</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">valid_wordlist_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">as</span> <span class="n">wordlist_file</span><span class="p">:</span>
        <span class="n">words</span> <span class="o">=</span> <span class="n">wordlist_file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

    <span class="k">print</span> <span class="n">msg</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">horror_rating</span><span class="p">)):</span>
        <span class="n">word</span> <span class="o">=</span> <span class="n">words</span><span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">))]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">p_msg</span> <span class="o">=</span> <span class="n">WORD_PROMPT</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">horror_rating</span><span class="p">,</span> <span class="n">word</span><span class="p">)</span>
        <span class="n">answer</span> <span class="o">=</span> <span class="n">prompt</span><span class="p">(</span><span class="n">p_msg</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="s">r&#39;^</span><span class="si">%s</span><span class="s">$&#39;</span> <span class="o">%</span> <span class="n">word</span><span class="p">)</span>
</pre></div>


<p>You may need to adjust <code>WORDLIST_PATHS</code> if you&#8217;re not on <span class="caps"><span class="caps">OS</span></span>&nbsp;X.</p>
<h2 id="working-with-third-party-apps">Working with&nbsp;Third-Party&nbsp;Apps</h2>
<p>One of the best parts about working with Django is that many problems have already
been solved and the solutions have been released as&nbsp;open-source&nbsp;applications.</p>
<p>We use quite a few open-source apps, and there are a couple of tricks I&#8217;ve learned to
make working with&nbsp;them&nbsp;easier.</p>
<h3 id="installing-apps-from-repositories">Installing Apps&nbsp;from&nbsp;Repositories</h3>
<p>If I&#8217;m going to use an open-source Django app in a project I&#8217;ll almost always install
it as an editable repository on the <span class="caps"><span class="caps">VM</span></span> with <code>pip install -e</code>.</p>
<p>Others may disagree with me on this, but I think it&#8217;s the best way&nbsp;to&nbsp;work.</p>
<p>Often I&#8217;ll find a bug that I think may be in one of the third-party apps I&#8217;m using.
Installing the apps as repositories makes it easy to read their source and figure out
if the bug is really in&nbsp;the&nbsp;app.</p>
<p>If the bug <em>is</em> in the third-party app having the app installed as a repository makes
it simple to fix the bug, fork the project on BitBucket or GitHub, send a pull
request, and get back&nbsp;to&nbsp;work.</p>
<h3 id="mirroring-repositories">Mirroring&nbsp;Repositories</h3>
<p>One problem we&#8217;ve run into at Dumbwaiter is that the repos for third-party apps we
use are scattered across GitHub, BitBucket, Google Code, and other servers.  If any
one of these services goes down we&#8217;re stuck waiting for it to come&nbsp;back&nbsp;up.</p>
<p>A while ago I took half a day and consolidated all of these repos onto one of the
servers that we control.  The basic process went&nbsp;like&nbsp;this:</p>
<ul>
<li>Use <a href="http://hg-git.github.com/">hg-git</a> and <a href="https://bitbucket.org/durin42/hgsubversion/wiki/Home">hgsubversion</a> to convert the git and <span class="caps"><span class="caps">SVN</span></span> repos to&nbsp;Mercurial&nbsp;repos.</li>
<li>Set up a master <code>mirror</code> Mercurial repo with all the app repos&nbsp;as&nbsp;subrepos.</li>
<li>Push the master repo and all the subrepos up to one of&nbsp;our&nbsp;Linodes.</li>
</ul>
<p>Now we can use <code>-e ssh://hg@OUR_LINODE/mirror/APP@REV_THAT_WORKS#egg=APP</code> in our
<code>requirements.txt</code> files to install apps from our mirror.  When we want to update our
dependencies we can simply pull from the upstream repos and commit in the&nbsp;mirror&nbsp;repo.</p>
<p>If our mirror goes down it&#8217;s not a big deal, because we have far bigger problems to
worry about than&nbsp;new&nbsp;projects.</p>
<p>I wrote a few scripts to automate updating apps and such, but they&#8217;re extremely hacky
so I don&#8217;t want to post them here.  Take half a day and write your own set &#8212; it&#8217;s
definitely worth it to have your own mirror of your&nbsp;specific&nbsp;dependencies.</p>
<h3 id="using-bcvi-to-edit-files">Using <span class="caps"><span class="caps">BCVI</span></span> to&nbsp;Edit&nbsp;Files</h3>
<p>I said that when I find a bug that I think is in a third-party app I&#8217;ll poke around
with the app and try to figure it out.  But since all the apps are installed in
a virtualenv on the Vagrant <span class="caps"><span class="caps">VM</span></span> it might seem like it&#8217;s a pain in the ass to edit&nbsp;those&nbsp;files!</p>
<p>Luckily <a href="http://sshmenu.sourceforge.net/articles/bcvi/"><span class="caps"><span class="caps">BCVI</span></span></a> exists.  It&#8217;s a utility that opens a &#8220;back channel&#8221; to your local
machine when you <span class="caps"><span class="caps">SSH</span></span> and lets you run <code>vi FILE</code> to open that file in
Vim/MacVim/GVim/etc on your <em>local</em> machine.  When you save the file it uploads it
back to the server automatically&nbsp;for&nbsp;you.</p>
<p>It can be a bit tricky to set up, but it&#8217;s worth it.&nbsp;Trust&nbsp;me.</p>
<h2 id="improving-the-admin-interface">Improving the&nbsp;Admin&nbsp;Interface</h2>
<p>I&#8217;m going to be honest: Django&#8217;s admin interface is the main reason I&#8217;m still using
it.  Other frameworks like <a href="http://flask.pocoo.org/">Flask</a> are great, but Django&#8217;s admin saves me
<em>ridiculous</em> amounts of time when I&#8217;m making simple <span class="caps"><span class="caps">CRUD</span></span> sites&nbsp;for&nbsp;clients.</p>
<p>That said, the Django admin isn&#8217;t the prettiest thing around, but we can give it&nbsp;a&nbsp;facelift.</p>
<h3 id="enter-grappelli">Enter&nbsp;Grappelli</h3>
<p><a href="http://django-grappelli.readthedocs.org/">Grappelli</a> is a Django app that reskins the admin interface beautifully.  It also
adds some functionality like drag-and-drop reordering of inlines, and allows you to
customize the dashboard to your liking.  <em>Every</em> Django site I work on uses Grappelli
&#8212; it&#8217;s just&nbsp;that&nbsp;good.</p>
<p>The downside of Grappelli is that it changes quite a lot and breaks backwards
compatibility at the drop of&nbsp;a&nbsp;hat.</p>
<p>If you&#8217;re going to use Grappelli you <em>must</em> freeze your requirements.txt files and
work with a single version at a time.  Trying to always work from the trunk will make&nbsp;you&nbsp;drink.</p>
<h3 id="an-ugly-hack-to-show-usable-foreign-key-fields">An Ugly Hack to Show Usable Foreign&nbsp;Key&nbsp;Fields</h3>
<p>A limitation of both Grappelli and the stock Django admin is that it seems like you
can&#8217;t easily show fields from related models in the admin&nbsp;list&nbsp;view.</p>
<p>For example, if you&#8217;re new to Django you might expect this&nbsp;to&nbsp;work:</p>
<div class="codehilite"><pre><span class="k">class</span> <span class="nc">BlogEntryAdmin</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
    <span class="n">list_display</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">,</span> <span class="s">&#39;author__name&#39;</span><span class="p">)</span>
</pre></div>


<p>Unfortunately Django chokes on the <code>author__name</code> lookup.  You can <em>display</em> the name
without too&nbsp;much&nbsp;fuss:</p>
<div class="codehilite"><pre><span class="k">class</span> <span class="nc">BlogEntryAdmin</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
    <span class="n">list_display</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">,</span> <span class="s">&#39;author_name&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">author_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">name</span>
</pre></div>


<p>That will display the name just fine.  However, it won&#8217;t be a fully-fledged column in
the Django admin because you can&#8217;t sort&nbsp;on&nbsp;it.</p>
<p>It may seem like this is the end &#8212; if it could be a fully-functional field, why
wouldn&#8217;t Django just let you use <code>author__name</code>?  Luckily we can add one more line to
fix&nbsp;the&nbsp;problem:</p>
<div class="codehilite"><pre><span class="k">class</span> <span class="nc">BlogEntryAdmin</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
    <span class="n">list_display</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">,</span> <span class="s">&#39;author_name&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">author_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">name</span>
    <span class="n">author_name</span><span class="o">.</span><span class="n">admin_order_field</span> <span class="o">=</span> <span class="s">&#39;author__name&#39;</span>
</pre></div>


<p>Now the author name has all the functionality of a real <code>list_display</code> entry.</p>
<h2 id="using-django-annoying">Using&nbsp;Django-Annoying</h2>
<p>If you haven&#8217;t heard of <a href="https://bitbucket.org/offline/django-annoying/wiki/Home">django-annoying</a> you should definitely check it out.  It&#8217;s
got a bunch of miscellaneous functions that fix some common, annoying parts&nbsp;of&nbsp;Django.</p>
<p>My two personal favorites from the package are a pair of decorators that help make
your views much,&nbsp;much&nbsp;cleaner.</p>
<h3 id="the-render95to-decorator">The&nbsp;render_to&nbsp;Decorator</h3>
<p>The decorator is called <code>render_to</code> and it eliminates the ugly <code>render_to_response</code>
calls that Django normally forces you to use in every&nbsp;single&nbsp;view.</p>
<p>Normally you&#8217;d use something&nbsp;like&nbsp;this:</p>
<div class="codehilite"><pre><span class="k">def</span> <span class="nf">videos</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">videos</span> <span class="o">=</span> <span class="n">Video</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;video_list.html&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="s">&#39;videos&#39;</span><span class="p">:</span> <span class="n">videos</span> <span class="p">},</span>
                              <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
</pre></div>


<p>With <code>render_to</code> your view gets&nbsp;much&nbsp;cleaner:</p>
<div class="codehilite"><pre><span class="nd">@render_to</span><span class="p">(</span><span class="s">&#39;video_list.html&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">videos</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">videos</span> <span class="o">=</span> <span class="n">Video</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">{</span> <span class="s">&#39;videos&#39;</span><span class="p">:</span> <span class="n">videos</span> <span class="p">}</span>
</pre></div>


<p>Less typing <code>context_instance=...</code> over and over, and less syntax&nbsp;to&nbsp;remember.</p>
<p>Yes, I know about Django 1.3&#8217;s <code>render</code> shortcut.  You have to type <code>request</code> every
single time with <code>render</code>, so the <code>render_to</code> decorator&nbsp;still&nbsp;wins.</p>
<h3 id="the-ajax95request-decorator">The&nbsp;ajax_request&nbsp;Decorator</h3>
<p>The <code>ajax_request</code> decorator is like <code>render_to</code> for <span class="caps"><span class="caps">AJAX</span></span> requests.  You simply
return a Python dictionary from your view and the decorator handles the <span class="caps"><span class="caps">JSON</span></span> encoding&nbsp;and&nbsp;such:</p>
<div class="codehilite"><pre><span class="nd">@ajax_request</span>
<span class="k">def</span> <span class="nf">ajax_get_entries</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">blog_entries</span> <span class="o">=</span> <span class="n">BlogEntry</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">{</span> <span class="s">&#39;entries&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="n">entry</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">get_absolute_url</span><span class="p">())</span>
                         <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">]}</span>
</pre></div>


<h2 id="templating-tricks">Templating&nbsp;Tricks</h2>
<p>I&#8217;m not a frontend developer, but I&#8217;ve done my share of <span class="caps"><span class="caps">HTML</span></span> hacking at Dumbwaiter.
Here are a few of the tricks&nbsp;I&#8217;ve&nbsp;learned.</p>
<h3 id="null-checks-and-fallbacks">Null Checks&nbsp;and&nbsp;Fallbacks</h3>
<p>A common pattern I see in Django templates looks&nbsp;like&nbsp;this:</p>
<div class="codehilite"><pre><span class="cp">{%</span> <span class="k">if</span> <span class="nv">business.title</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">    </span><span class="cp">{{</span> <span class="nv">business.title</span> <span class="cp">}}</span><span class="x"></span>
<span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">    </span><span class="cp">{{</span> <span class="nv">business.short_title</span> <span class="cp">}}</span><span class="x"></span>
<span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"></span>
</pre></div>


<p>Here&#8217;s a simpler way to&nbsp;do&nbsp;that:</p>
<div class="codehilite"><pre><span class="cp">{%</span> <span class="k">firstof</span> <span class="nv">business.title</span> <span class="nv">business.short_title</span> <span class="cp">%}</span><span class="x"></span>
</pre></div>


<p><code>firstof</code> will return the first non-Falsy item in&nbsp;its&nbsp;arguments.</p>
<h3 id="manipulating-query-strings">Manipulating&nbsp;Query&nbsp;Strings</h3>
<p>Query strings are normally not a big deal, but every once in a while you&#8217;ll have
a model listing page where you need to filter by category, and number of spaces, and
tags, etc all&nbsp;at&nbsp;once.</p>
<p>If you&#8217;re trying to manage <span class="caps"><span class="caps">GET</span></span> queries manually it can get pretty hairy&nbsp;very&nbsp;fast.</p>
<p><a href="http://djangosnippets.org/snippets/2237/">This Django snippet</a> makes working with query strings in templates&nbsp;a&nbsp;breeze.</p>
<h3 id="satisfying-your-designer-with-typogrify">Satisfying Your Designer&nbsp;with&nbsp;Typogrify</h3>
<p>If you haven&#8217;t heard of <a href="http://code.google.com/p/typogrify/">Typogrify</a> you should take a look at it.  It makes it easy
to add all the typographic goodness your designers are&nbsp;looking&nbsp;for.</p>
<h2 id="the-flat-page-trainwreck">The Flat&nbsp;Page&nbsp;Trainwreck</h2>
<p>Creating a site for a client is very different than creating a site for yourself.
For pretty much every client we&#8217;ve dealt with we&#8217;ve heard: &#8220;can&#8217;t we just create
a new page at /drink-special/ for this special deal&nbsp;we&#8217;re&nbsp;running?&#8221;</p>
<p>Having clients go through you to make new pages is simply too much overhead.  We
needed a way to let clients create new pages (like <code>/drink-special/</code>) on the fly,
without&nbsp;our&nbsp;intervention.</p>
<p>Django has a &#8220;flatpages&#8221; app that solves this problem.&nbsp;Kind&nbsp;of.</p>
<p>When using flat pages clients need to do two things that are often too much for&nbsp;non-technical&nbsp;people:</p>
<ul>
<li>Manage&nbsp;URLs&nbsp;manually.</li>
<li>Write all content as raw <span class="caps"><span class="caps">HTML</span></span> in a single&nbsp;text&nbsp;field.</li>
</ul>
<p>We&#8217;ve tried a lot of Django <span class="caps"><span class="caps">CMS</span></span> apps at Dumbwaiter, and none of them made us happy.
They all seemed to have some or all of the&nbsp;following&nbsp;problems:</p>
<ul>
<li>They take over your site and make you write a &#8220;Django-WhateverCMS site&#8221; instead of
  a&nbsp;&#8220;Django&nbsp;site&#8221;.</li>
<li>They&#8217;re extremely feature-rich and complicated with features like
  internationalization, redirects, versions, and many others.  This is great if you
  need the flexibility, but bad if your clients just need to create a couple&nbsp;of&nbsp;pages.</li>
<li>They break <code>APPEND_TRAILING_SLASH</code> and make you clutter your <code>urls.py</code> files with
  a bunch of extra code ot&nbsp;handle&nbsp;this.</li>
</ul>
<p>I finally got fed up and wrote my own Django <span class="caps"><span class="caps">CMS</span></span> app: <a href="http://stoat.rtfd.org/">Stoat</a>.  Stoat is designed
to be sleek, with only the features that our&nbsp;clients&nbsp;need.</p>
<p>It&#8217;s not officially version 1.0 yet, but we&#8217;re using it for a few clients and it&#8217;s
working well.  Check it out if you&#8217;re looking for a more lightweight <span class="caps"><span class="caps">CMS</span></span>&nbsp;app.</p>
<h2 id="editing-with-vim">Editing&nbsp;with&nbsp;Vim</h2>
<p>I <a href="/blog/2010/09/coming-home-to-vim/">use Vim</a> to edit everything.  Naturally I&#8217;ve found a bunch of plugins,
mappings and other tricks that make it even better when working on&nbsp;Django&nbsp;projects.</p>
<h3 id="vim-for-django">Vim&nbsp;for&nbsp;Django</h3>
<p>There are a lot of ways to make Vim work with Django.  I won&#8217;t go into all of them in
this post, but a good place to start is <a href="https://code.djangoproject.com/wiki/UsingVimWithDjango">this Django wiki page</a>.</p>
<h3 id="filetype-mappings">Filetype&nbsp;Mappings</h3>
<p>Most files in a Django project have one of two extensions: <code>.py</code> and <code>.html</code>.
Unfortunately these extensions aren&#8217;t unique to Django, so Vim doesn&#8217;t automatically
set the correct <code>filetype</code> when you&nbsp;open&nbsp;one.</p>
<p>I&#8217;ve added a few mappings to my <code>.vimrc</code> to make it quick and easy to set the correct
<code>filetype</code>:</p>
<div class="codehilite"><pre>nnoremap _dt :<span class="k">set</span> <span class="nb">ft</span><span class="p">=</span>htmldjango<span class="p">&lt;</span><span class="caps"><span class="caps">CR</span></span><span class="p">&gt;</span>
nnoremap _pd :<span class="k">set</span> <span class="nb">ft</span><span class="p">=</span>python.django<span class="p">&lt;</span><span class="caps"><span class="caps">CR</span></span><span class="p">&gt;</span>
</pre></div>


<p>I also have a few autocommands that set the filetype for me when I&#8217;m editing a file
whose name &#8220;sounds like&#8221; a&nbsp;Django&nbsp;file:</p>
<div class="codehilite"><pre>au <span class="nb">BufNewFile</span><span class="p">,</span><span class="nb">BufRead</span> admin.<span class="k">py</span>     <span class="k">setlocal</span> <span class="k">filetype</span><span class="p">=</span>python.django
au <span class="nb">BufNewFile</span><span class="p">,</span><span class="nb">BufRead</span> urls.<span class="k">py</span>      <span class="k">setlocal</span> <span class="k">filetype</span><span class="p">=</span>python.django
au <span class="nb">BufNewFile</span><span class="p">,</span><span class="nb">BufRead</span> models.<span class="k">py</span>    <span class="k">setlocal</span> <span class="k">filetype</span><span class="p">=</span>python.django
au <span class="nb">BufNewFile</span><span class="p">,</span><span class="nb">BufRead</span> views.<span class="k">py</span>     <span class="k">setlocal</span> <span class="k">filetype</span><span class="p">=</span>python.django
au <span class="nb">BufNewFile</span><span class="p">,</span><span class="nb">BufRead</span> settings.<span class="k">py</span>  <span class="k">setlocal</span> <span class="k">filetype</span><span class="p">=</span>python.django
au <span class="nb">BufNewFile</span><span class="p">,</span><span class="nb">BufRead</span> forms.<span class="k">py</span>     <span class="k">setlocal</span> <span class="k">filetype</span><span class="p">=</span>python.django
</pre></div>


<h3 id="python-sanity-checking">Python&nbsp;Sanity&nbsp;Checking</h3>
<p>Lets be honest here: it takes a lot of work to turn Vim into an &#8220;<span class="caps"><span class="caps">IDE</span></span>&#8221;, and even then
it doesn&#8217;t reach the level of something like Eclipse for Java.  Anyone who claims it
has the same levels of integration and functionality is&nbsp;simply&nbsp;lying.</p>
<p>With that said I&#8217;ll make an opinionated statement that is going to piss some of&nbsp;you&nbsp;off.</p>
<p><strong>I am a programmer, not an <span class="caps"><span class="caps">IDE</span></span>&nbsp;operator.</strong></p>
<p>I&nbsp;know&nbsp;Python.</p>
<p>I&nbsp;know&nbsp;Django.</p>
<p>I don&#8217;t need to hit Cmd+Space twice for every line of code&nbsp;I&nbsp;write.</p>
<p>When someone asks me &#8220;how do you run your site&#8221; I do <strong>not</strong> answer: &#8220;click the green
triangle&nbsp;in&nbsp;Eclipse&#8221;.</p>
<p>However, I am human.  I do stupid things like forgetting a colon or forgetting an
import.  To help me with those problems I&#8217;ve turned to <a href="http://www.vim.org/scripts/script.php?script_id=2736">Syntastic</a> and Kevin
Watters&#8217; <a href="https://github.com/kevinw/pyflakes">Pyflakes fork</a>&nbsp;for&nbsp;Vim.</p>
<p>Syntastic is a Vim plugin that adds on-the-fly syntax-checking for many different
file formats.  If you have Pyflakes installed it will automatically show you errors
in&nbsp;your&nbsp;code.</p>
<p>Pyflakes doesn&#8217;t have <span class="caps"><span class="caps">IDE</span></span>-level integration with your code.  It doesn&#8217;t check that
whatever libraries you <code>import</code> actually exist.  It simply checks that your files are
probably-valid Python, and tells you when&nbsp;they&#8217;re&nbsp;not.</p>
<p>This is enough for me.  It catches the stupid mistakes I make.  The less-stupid,
more-subtle mistakes slip by it, but to be fair many of them would have slipped by an
&#8220;<span class="caps"><span class="caps">IDE</span></span>&#8221;&nbsp;as&nbsp;well.</p>
<h3 id="javascript-sanity-checking-and-folding">Javascript Sanity Checking&nbsp;and&nbsp;Folding</h3>
<p>Syntastic also supports Javascript if you have Javascript Lint installed (<code>brew
install jsl</code> on <span class="caps"><span class="caps">OS</span></span> X).  It&#8217;s not perfect but it <em>will</em> catch things like using
trailing commas in&nbsp;object&nbsp;literals.</p>
<p>Some people like using CTags to get an overview of their code.  I take a more
low-tech approach and am in love with code folding.  When I fold my code
I automatically get an overview of everything in&nbsp;each&nbsp;file.</p>
<p>By default Vim doesn&#8217;t fold Javascript files, but you can add some basic, perfectly
serviceable folding with these two lines in&nbsp;your&nbsp;.vimrc:</p>
<div class="codehilite"><pre>au <span class="nb">FileType</span> javascript <span class="k">setlocal</span> <span class="nb">foldmethod</span><span class="p">=</span>marker
au <span class="nb">FileType</span> javascript <span class="k">setlocal</span> <span class="nb">foldmarker</span><span class="p">=</span>{<span class="p">,</span>}
</pre></div>


<h3 id="django-autocommands">Django&nbsp;Autocommands</h3>
<p>I <em>rarely</em> work with raw <span class="caps"><span class="caps">HTML</span></span> files any more.  Whenever I open a file ending in
<code>.html</code> it&#8217;s almost always a Django template (or a <a href="http://jinja.pocoo.org/">Jinja</a> template, which has
a very similar syntax).  I&#8217;ve added an autocommand to automatically set the correct
filetype whenever I open a <code>.html</code> file:</p>
<div class="codehilite"><pre>au <span class="nb">BufNewFile</span><span class="p">,</span><span class="nb">BufRead</span> *.html <span class="k">setlocal</span> <span class="k">filetype</span><span class="p">=</span>htmldjango
</pre></div>


<p>I also have some autocommands that tweak how a few specific files&nbsp;are&nbsp;handled:</p>
<div class="codehilite"><pre>au <span class="nb">BufNewFile</span><span class="p">,</span><span class="nb">BufRead</span> urls.<span class="k">py</span>      <span class="k">setlocal</span> <span class="nb">nowrap</span>
au <span class="nb">BufNewFile</span><span class="p">,</span><span class="nb">BufRead</span> settings.<span class="k">py</span>  normal<span class="p">!</span> zR
au <span class="nb">BufNewFile</span><span class="p">,</span><span class="nb">BufRead</span> dashboard.<span class="k">py</span> normal<span class="p">!</span> zR
</pre></div>


<p>This automatically unfolds <code>urls.py</code>, <code>dashboard.py</code> and <code>settings.py</code> (I prefer
seeing those unfolded) and unsets line wrapping for <code>urls.py</code> (lines in a <code>urls.py</code>
file can get long and are hard to read&nbsp;when&nbsp;wrapped).</p>
<h2 id="conclusion">Conclusion</h2>
<p>I hope that this longer-than-expected blog entry has given you at least one or two
things to&nbsp;think&nbsp;about.</p>
<p>I&#8217;ve learned a lot while working with Django for Dumbwaiter every day, but I&#8217;m sure
there&#8217;s still a lot I&#8217;ve missed.  If you see something I could be doing better please
let&nbsp;me&nbsp;know!</p>
                
            <!-- Hyde::Article::End -->
        
    </div>

                    
                
            </div>

            <div class="hrb">&nbsp;</div>

            <footer>
                I'm also on
                <a href="http://bitbucket.org/sjl/">BitBucket</a>,
                <a href="http://github.com/sjl/">GitHub</a>,
                <a href="http://twitter.com/stevelosh/">Twitter</a>,
                <a href="http://forrst.com/people/stevelosh/">Forrst</a>
                and
                <a href="http://flickr.com/photos/sjl7678/">Flickr</a>.
                I've got <a href="#" class="rhythm">rhythm</a>.
            </footer>
        </div>
    </body>

    <script type="text/javascript">
        var _gauges = _gauges || [];
        (function() {
         var t   = document.createElement('script');
         t.type  = 'text/javascript';
         t.async = true;
         t.id    = 'gauges-tracker';
         t.setAttribute('data-site-id', '4e8f83a7f5a1f53f20000011');
         t.src = '//secure.gaug.es/track.js';
         var s = document.getElementsByTagName('script')[0];
         s.parentNode.insertBefore(t, s);
         })();
     </script>
</html>
