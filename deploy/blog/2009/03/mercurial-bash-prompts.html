
<!DOCTYPE html>
<html>
    <head>
        <link href='http://fonts.googleapis.com/css?family=OFL+Sorts+Mill+Goudy+TT:regular,italic' rel='stylesheet' type='text/css' />
        <link rel="profile" href="http://microformats.org/profile/hcard" />
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />

        <title>Mercurial Bash Prompts : Less Selling</title>

        
            <link href="http://feeds2.feedburner.com/stevelosh"
                  rel="alternate" title="Less Selling"
                  type="application/atom+xml" />
        

        
            <link rel="stylesheet" href="/media/css/aal.css"      type="text/css" media="screen" charset="utf-8" />
            <link rel="stylesheet" href="/media/css/sjl.css"      type="text/css" media="screen" charset="utf-8" />
            <link rel="stylesheet" href="/media/css/print.css"    type="text/css" media="print" charset="utf-8" />
            
    <link rel="stylesheet"
          href="/media/css/pygments-monokai-light.css"
          type="text/css" media="screen" charset="utf-8" />

        

        
            <script src="/media/js/jquery.js" type="text/javascript"></script>
            <script src="/media/js/jquery.timeago.js" type="text/javascript"></script>
            <script src="/media/js/sjl.js" type="text/javascript"></script>
            <script src="/media/js/print.js" type="text/javascript"></script>

            <script type="text/javascript">
                $(function() {
                    $("a.rhythm").toggle(function() {
                        $("body").addClass("rhythm");
                    }, function() {
                        $("body").removeClass("rhythm");
                    });
                });
            </script>

            <script type="text/javascript">
            /* <![CDATA[ */
                (function() {
                    var s = document.createElement('script'), t = document.getElementsByTagName('script')[0];

                    s.type = 'text/javascript';
                    s.async = true;
                    s.src = 'http://api.flattr.com/js/0.5.0/load.js?mode=auto';

                    t.parentNode.insertBefore(s, t);
                })();
            /* ]]> */
            </script>

            
        

        <script type="text/javascript">
          var _gaq = _gaq || [];
          _gaq.push(['_setAccount', 'UA-28389034-1']);
          _gaq.push(['_trackPageview']);

          (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
          })();
        </script>

    </head>

    <body>
        <div class="wrap">
            <div class="top group">
                <header>
                    <a href="/">less selling</a>
                </header>

                <nav>
                    <a href="/blog/">Blog</a>
                    <span class="sep">-</span>
                    <a href="/projects">Projects</a>
                    <span class="sep">-</span>
                    <a href="/about/">About</a>
                    <span class="sep">-</span>
                    <a href="http://feeds2.feedburner.com/stevelosh">Feed</a>
                </nav>
            </div>

            <div class="hr">&nbsp;</div>

            <div class="content">
                
                    
                        
    <div id="leaf-title">
        <h1><a href="/blog/2009/03/mercurial-bash-prompts/">Mercurial Bash&nbsp;Prompts</a></h1>
    </div>


    <div id="leaf-stats" class="group">
        
            <div class="flattr">
                <a class="FlattrButton" style="display:none;" rev="flattr;button:compact;"
                   href="http://stevelosh.com/blog/2009/03/mercurial-bash-prompts/"></a>
           </div>
        
        <p>
            Posted
            <span class="timeago"
                  title="2009-03-17T21:34:55">
            </span>
            on March 17, 2009.
        </p>
    </div>

    <div id="leaf-content" class="">
        
            <!-- Hyde::Article::Begin -->
                
                    <p>I&#8217;ve been spending a lot of time in the Terminal lately. I use bash, and it
lets you configure the prompt pretty much however you want. I won&#8217;t go into
how to do the most basic configuration here - if you want to get up to speed
check out this <a href="http://www.ibm.com/developerworks/linux/library/l-tip-prompt/">guide</a>.</p>
<p>In this post I&#8217;m just going to talk about one simple addition that I
personally find very helpful: displaying the current branch of a <a href="http://mercurial.selenic.com/">Mercurial</a>&nbsp;repository.</p>
<h2 id="update-the-hg-prompt-extension">Update: the&nbsp;hg-prompt&nbsp;Extension</h2>
<p>I swear, this is the last time I&#8217;m updating this entry. I went ahead and made
an extension for Mercurial called
<a href="http://stevelosh.com/projects/hg-prompt/">hg-prompt</a> that does everything
much more elegantly. <strong>Use&nbsp;that&nbsp;instead!</strong></p>
<h2 id="my-starting-point">My&nbsp;Starting&nbsp;Point</h2>
<p>Here&#8217;s what my prompt looked like a couple of&nbsp;days&nbsp;ago:</p>
<p><img alt="My bash prompt without the branch displayed" src="/media/images/blog/2009/03/prompt-without-branch.png" title="My bash prompt without the branch displayed." /></p>
<p>Here&#8217;s the code in my <code>.bashrc</code> file to create it. I&#8217;ve stripped out the color
information to&nbsp;save&nbsp;space.</p>
<div class="codehilite"><pre><span class="nb">export </span><span class="nv"><span class="caps"><span class="caps">PS1</span></span></span><span class="o">=</span><span class="s1">&#39;\n\u at \h in \w\n$ &#39;</span>
</pre></div>


<p>I use the same prompt on every computer I work with, so with this prompt I can
see which user I&#8217;m logged in as, which machine I&#8217;m on, and where in the
filesystem I am. It&#8217;s a lot of useful information at a glance but doesn&#8217;t seem&nbsp;too&nbsp;cluttered.</p>
<p>I have a linebreak in there because the filesystem path can get pretty long.
If I kept it all on one line most of my commands would be wrapped around
anyway, which I find harder&nbsp;to&nbsp;read.</p>
<h2 id="adding-the-mercurial-branch">Adding the&nbsp;Mercurial&nbsp;Branch</h2>
<p>I use Mercurial for version control, and I use branches quite a bit when I&#8217;m
developing. One problem with this is that it&#8217;s easy to forget which branch I&#8217;m
on at a given moment. I <em>could</em> just use <code>hg branch</code> to find out, but that
gets tedious to type, even when aliased to something like <code>hb</code>.</p>
<p>A few days ago I got the idea that I could just display the current branch on
my prompt whenever I&#8217;m in a directory that&#8217;s part of a repository. Here&#8217;s what
my prompt looks&nbsp;like&nbsp;now:</p>
<p><img alt="My bash prompt with the branch displayed" src="/media/images/blog/2009/03/prompt-with-branch.png" title="My bash prompt with the branch displayed." /></p>
<p>And here&#8217;s the code in my <code>.bashrc</code> that&nbsp;does&nbsp;it:</p>
<div class="codehilite"><pre>hg_in_repo<span class="o">()</span> <span class="o">{</span>
    hg branch 2&gt; /dev/null | awk <span class="s1">&#39;{print &quot;on &quot;}&#39;</span>
<span class="o">}</span>

hg_branch<span class="o">()</span> <span class="o">{</span>
    hg branch 2&gt; /dev/null | awk <span class="s1">&#39;{print $1}&#39;</span>
<span class="o">}</span>

<span class="nb">export </span><span class="nv"><span class="caps"><span class="caps">PS1</span></span></span><span class="o">=</span><span class="s1">&#39;\n\u at \h in \w $(hg_in_repo)$(hg_branch)\n$ &#39;</span>
</pre></div>


<p>The <code>on branchname</code> piece is only displayed when you&#8217;re in a directory that&#8217;s
part of a&nbsp;Mercurial&nbsp;repository.</p>
<p>I&#8217;ve split it up into two separate functions because I wanted to have <code>on</code> and
<code>branchname</code> displayed in two different colors. I couldn&#8217;t seem to include the
color codes in the awk command, so I split it up and put the colors in the
export statement with the rest of them. If you don&#8217;t care about colors (or
don&#8217;t mind having both words the same color) you can just collapse it into&nbsp;one&nbsp;function.</p>
<h2 id="updated-is-it-dirty">Updated: Is&nbsp;It&nbsp;Dirty?</h2>
<p>After I posted this entry Matt Kemp commented with a link to a <a href="http://gist.github.com/31631">git
version</a>. One feature that version has is a simple indicator of whether or
not the repository you&#8217;re in is dirty. I ported it to Mercurial and here&#8217;s&nbsp;the&nbsp;result:</p>
<p><img alt="My bash prompt with the branch and dirty indicator displayed" src="/media/images/blog/2009/03/prompt-with-dirty.png" title="My bash prompt with the branch and dirty indicator displayed." /></p>
<p>And the code in <code>.bashrc</code>:</p>
<div class="codehilite"><pre>hg_dirty<span class="o">()</span> <span class="o">{</span>
    hg status --no-color 2&gt; /dev/null <span class="se">\</span>
    | awk <span class="s1">&#39;$1 == &quot;?&quot; { print &quot;?&quot; } $1 != &quot;?&quot; { print &quot;!&quot; }&#39;</span> <span class="se">\</span>
    | sort | uniq | head -c1
<span class="o">}</span>

hg_in_repo<span class="o">()</span> <span class="o">{</span>
    <span class="o">[[</span> <span class="sb">`</span>hg branch 2&gt; /dev/null<span class="sb">`</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s1">&#39;on &#39;</span>
<span class="o">}</span>

hg_branch<span class="o">()</span> <span class="o">{</span>
    hg branch 2&gt; /dev/null
<span class="o">}</span>

<span class="nb">export </span><span class="nv"><span class="caps"><span class="caps">PS1</span></span></span><span class="o">=</span><span class="s1">&#39;\n\u at \h in \w $(hg_in_repo)$(hg_branch)$(hg_dirty)\n$ &#39;</span>
</pre></div>


<p>This gives you a <code>?</code> after the branch when there are untracked files (and
<em>only</em> untracked files), and a <code>!</code> if there are any modified,&nbsp;tracked&nbsp;files.</p>
<h2 id="updated-bookmarks-too">Updated:&nbsp;Bookmarks&nbsp;Too!</h2>
<p>I&#8217;ve added another piece to show bookmarks as well. I&#8217;ve also figured out how
to add colors directly in the functions, so here&#8217;s the (much nicer) updated
code all&nbsp;at&nbsp;once:</p>
<div class="codehilite"><pre><span class="nv"><span class="caps"><span class="caps">DEFAULT</span></span></span><span class="o">=</span><span class="s2">&quot;[37;40m&quot;</span>
<span class="nv"><span class="caps"><span class="caps">PINK</span></span></span><span class="o">=</span><span class="s2">&quot;[35;40m&quot;</span>
<span class="nv"><span class="caps"><span class="caps">GREEN</span></span></span><span class="o">=</span><span class="s2">&quot;[32;40m&quot;</span>
<span class="nv"><span class="caps"><span class="caps">ORANGE</span></span></span><span class="o">=</span><span class="s2">&quot;[33;40m&quot;</span>

hg_dirty<span class="o">()</span> <span class="o">{</span>
    hg status --no-color 2&gt; /dev/null <span class="se">\</span>
    | awk <span class="s1">&#39;$1 == &quot;?&quot; { unknown = 1 } </span>
<span class="s1">           $1 != &quot;?&quot; { changed = 1 }</span>
<span class="s1">           <span class="caps"><span class="caps">END</span></span> {</span>
<span class="s1">             if (changed) printf &quot;!&quot;</span>
<span class="s1">             else if (unknown) printf &quot;?&quot; </span>
<span class="s1">           }&#39;</span>
<span class="o">}</span>

hg_branch<span class="o">()</span> <span class="o">{</span>
    hg branch 2&gt; /dev/null | <span class="se">\</span>
        awk <span class="s1">&#39;{ printf &quot;\033[37;0m on \033[35;40m&quot; $1 }&#39;</span>
    hg bookmarks 2&gt; /dev/null | <span class="se">\</span>
        awk <span class="s1">&#39;/\*/ { printf &quot;\033[37;0m at \033[33;40m&quot; $2 }&#39;</span>
<span class="o">}</span>

<span class="nb">export </span><span class="nv"><span class="caps"><span class="caps">PS1</span></span></span><span class="o">=</span><span class="s1">&#39;\n\e${<span class="caps"><span class="caps">PINK</span></span>}\u \</span>
<span class="s1">\e${<span class="caps"><span class="caps">DEFAULT</span></span>}at \e${<span class="caps"><span class="caps">ORANGE</span></span>}\h \</span>
<span class="s1">\e${<span class="caps"><span class="caps">DEFAULT</span></span>}in \e${<span class="caps"><span class="caps">GREEN</span></span>}\w\</span>
<span class="s1">$(hg_branch)\e${<span class="caps"><span class="caps">GREEN</span></span>}$(hg_dirty)\</span>
<span class="s1">\e${<span class="caps"><span class="caps">DEFAULT</span></span>}\n$ &#39;</span>
</pre></div>


<p>These are some pretty simple changes but they help keep me sane. One thing to
be aware of: if you use all of these it does slow down the rendering of the
prompt by a tiny, but noticeable, amount. I&#8217;m not the strongest bash scripter,
so if there&#8217;s a better way to do this (or a way that will make it faster and
reduce the delay) please let&nbsp;me&nbsp;know!</p>
<p><strong><span class="caps"><span class="caps">UPDATE</span></span>:</strong> Matt Kemp posted a link to a <a href="http://gist.github.com/31631">git version</a> of this below. If you
use git, check it out! One thing that version has that I didn&#8217;t think of is an
indicator of whether the repository is dirty (has uncommitted changes). I&#8217;m
going to go ahead and steal that idea for my&nbsp;prompt&nbsp;too.</p>
<p><strong><span class="caps"><span class="caps">UPDATE</span></span>:</strong> By request, I&#8217;ve written <a href="/blog/entry/2009/3/18/candy-colored-terminal/">an entry about the
colors</a>.</p>
<p><strong><span class="caps"><span class="caps">UPDATE</span></span>:</strong> Kevin Bullock pointed out that the Python interpreter needed to be
started a bunch of times which will degrade performance. I&#8217;ve changed up the
&#8220;dirty&#8221; code a bit to reduce the number of interpreters needed. It&#8217;s still not
as efficient as his version, but I think it&#8217;s about as good as I&#8217;m going to
get if I want separate colors for the pieces and don&#8217;t want to rely on an&nbsp;external&nbsp;script.</p>
<p><strong><span class="caps"><span class="caps">FINAL</span></span> <span class="caps"><span class="caps">UPDATE</span></span>:</strong> I made an extension for Mercurial called
<a href="http://stevelosh.com/projects/hg-prompt/">hg-prompt</a> that does everything
much more elegantly. <strong>Use&nbsp;that&nbsp;instead!</strong></p>
                
            <!-- Hyde::Article::End -->
        
    </div>

                    
                
            </div>

            <div class="hrb">&nbsp;</div>

            <footer>
                I'm also on
                <a href="http://bitbucket.org/sjl/">BitBucket</a>,
                <a href="http://github.com/sjl/">GitHub</a>,
                <a href="http://twitter.com/stevelosh/">Twitter</a>,
                <a href="http://forrst.com/people/stevelosh/">Forrst</a>
                and
                <a href="http://flickr.com/photos/sjl7678/">Flickr</a>.
                I've got <a href="#" class="rhythm">rhythm</a>.
            </footer>
        </div>
    </body>

</html>
