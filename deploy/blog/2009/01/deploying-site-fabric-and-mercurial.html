
<!DOCTYPE html>
<html>
    <head>
        <link href='http://fonts.googleapis.com/css?family=OFL+Sorts+Mill+Goudy+TT:regular,italic' rel='stylesheet' type='text/css' />
        <link rel="profile" href="http://microformats.org/profile/hcard" />
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />

        <title>Deploying with Fabric &amp; Mercurial : Less Selling</title>

        
            <link href="http://feeds2.feedburner.com/stevelosh"
                  rel="alternate" title="Less Selling"
                  type="application/atom+xml" />
        

        
            <link rel="stylesheet" href="/media/css/aal.css"      type="text/css" media="screen" charset="utf-8" />
            <link rel="stylesheet" href="/media/css/sjl.css"      type="text/css" media="screen" charset="utf-8" />
            <link rel="stylesheet" href="/media/css/print.css"    type="text/css" media="print" charset="utf-8" />
            
    <link rel="stylesheet"
          href="/media/css/pygments-monokai-light.css"
          type="text/css" media="screen" charset="utf-8" />

        

        
            <script src="/media/js/jquery.js" type="text/javascript"></script>
            <script src="/media/js/jquery.timeago.js" type="text/javascript"></script>
            <script src="/media/js/sjl.js" type="text/javascript"></script>
            <script src="/media/js/print.js" type="text/javascript"></script>

            <script type="text/javascript">
                $(function() {
                    $("a.rhythm").toggle(function() {
                        $("body").addClass("rhythm");
                    }, function() {
                        $("body").removeClass("rhythm");
                    });
                });
            </script>

            <script type="text/javascript">
            /* <![CDATA[ */
                (function() {
                    var s = document.createElement('script'), t = document.getElementsByTagName('script')[0];

                    s.type = 'text/javascript';
                    s.async = true;
                    s.src = 'http://api.flattr.com/js/0.5.0/load.js?mode=auto';

                    t.parentNode.insertBefore(s, t);
                })();
            /* ]]> */
            </script>

            
        

        <script type="text/javascript">
          var _gaq = _gaq || [];
          _gaq.push(['_setAccount', 'UA-28389034-1']);
          _gaq.push(['_trackPageview']);

          (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
          })();
        </script>

    </head>

    <body>
        <div class="wrap">
            <div class="top group">
                <header>
                    <a href="/">less selling</a>
                </header>

                <nav>
                    <a href="/blog/">Blog</a>
                    <span class="sep">-</span>
                    <a href="/projects">Projects</a>
                    <span class="sep">-</span>
                    <a href="/about/">About</a>
                    <span class="sep">-</span>
                    <a href="http://feeds2.feedburner.com/stevelosh">Feed</a>
                </nav>
            </div>

            <div class="hr">&nbsp;</div>

            <div class="content">
                
                    
                        
    <div id="leaf-title">
        <h1><a href="/blog/2009/01/deploying-site-fabric-and-mercurial/">Deploying with Fabric <span class="amp">&amp;</span>&nbsp;Mercurial</a></h1>
    </div>


    <div id="leaf-stats" class="group">
        
            <div class="flattr">
                <a class="FlattrButton" style="display:none;" rev="flattr;button:compact;"
                   href="http://stevelosh.com/blog/2009/01/deploying-site-fabric-and-mercurial/"></a>
           </div>
        
        <p>
            Posted
            <span class="timeago"
                  title="2009-01-15T20:51:09">
            </span>
            on January 15, 2009.
        </p>
    </div>

    <div id="leaf-content" class="">
        
            <!-- Hyde::Article::Begin -->
                
                    <p>Earlier tonight I added support for the <a href="http://haveamint.com">Mint</a> <a href="http://haveamint.com/peppermill/pepper/11/bird_feeder/">Bird Feeder</a> plugin to my
site&#8217;s <a href="/rss/"><span class="caps"><span class="caps">RSS</span></span> feeds</a>. Bird Feeder isn&#8217;t designed to work with <a href="http://www.djangoproject.com/">Django</a> so I
had to change a few things to get it up and running. I mostly followed the
<a href="http://hicks-wright.net/blog/minty-django-feeds/">instructions on
Hicks-Wright.net</a> with a&nbsp;few&nbsp;tweaks.</p>
<p>While I was trying to get things running smoothly I had to redeploy the site a
bunch of times so I could test the changes I made. If I were simply <span class="caps"><span class="caps">FTP</span></span>&#8217;ing
the files over each time I wanted to redeploy it would have been a huge pain.
Fortunately, I have another way to do it that cuts down on&nbsp;my&nbsp;typing.</p>
<div class="toc">
<ul>
<li><a href="#my-basic-deployment-steps">My Basic&nbsp;Deployment&nbsp;Steps</a></li>
<li><a href="#putting-bitbucket-in-the-middle">Putting BitBucket in the Middle</a><ul>
<li><a href="#set-up-your-local-machine">Set Up Your&nbsp;Local&nbsp;Machine</a></li>
<li><a href="#set-up-your-server">Set Up&nbsp;Your&nbsp;Server</a></li>
</ul>
</li>
<li><a href="#weaving-it-all-together-with-fabric">Weaving it All Together with Fabric</a><ul>
<li><a href="#my-current-setup">My&nbsp;Current&nbsp;Setup</a></li>
<li><a href="#extending-it">Extending&nbsp;It</a></li>
</ul>
</li>
<li><a href="#why-should-you-try-this">Why Should You&nbsp;Try&nbsp;This?</a></li>
<li><a href="#update">Update</a></li>
</ul>
</div>
<h2 id="my-basic-deployment-steps">My Basic&nbsp;Deployment&nbsp;Steps</h2>
<p>The code for my site is stored in a Mercurial repository. There are actually
three copies of the repository that&nbsp;I&nbsp;use:</p>
<ul>
<li>One is on my local machine, which I commit to as I&nbsp;make&nbsp;changes.</li>
<li>One is on <a href="http://bitbucket.org">BitBucket</a>, which I use to share the code with&nbsp;the&nbsp;public.</li>
<li>One is on my host&#8217;s webserver, and is what actually gets served as&nbsp;the&nbsp;website.</li>
</ul>
<p>When I&#8217;m ready to deploy a new version of the site, I push the changes I&#8217;ve
made on my local repository to the one on BitBucket, then pull the changes
from BitBucket down to the server. Using push/pull means I don&#8217;t have to worry
about transferring the files myself. Using BitBucket in the middle (instead of
going right from my local machine to the server) means I don&#8217;t have to worry
about serving either repository myself and dealing with port forwarding or&nbsp;security&nbsp;issues.</p>
<h2 id="putting-bitbucket-in-the-middle">Putting BitBucket in&nbsp;the&nbsp;Middle</h2>
<p>Using BitBucket as an intermediate repository is actually fairly simple. Here
are the basic steps I use to get a project up and running&nbsp;like&nbsp;this.</p>
<p>First, create a new repository on BitBucket. Make sure the name is what you
want. Feel free to make it private if you just want it for this, or public if
you want to <a href="/blog/entry/2009/1/13/going-open-source/">go open source</a>.</p>
<h3 id="set-up-your-local-machine">Set Up Your&nbsp;Local&nbsp;Machine</h3>
<p>Clone this new, empty repository to your local machine. If you already have
code written you&#8217;ll need to copy it into this folder after cloning. I don&#8217;t
know if there&#8217;s a way to push a brand-new repository to BitBucket; if you know
how please&nbsp;tell&nbsp;me.</p>
<p>On your local machine, edit the <code>.hg/hgrc</code> file in the repository and change
the default&nbsp;path&nbsp;to:</p>
<div class="codehilite"><pre><span class="na">default</span> <span class="o">=</span> <span class="s">ssh://hg@bitbucket.org/username/repositoryname/</span>
</pre></div>


<p>That will let you push/pull to and from BitBucket over <span class="caps"><span class="caps">SSH</span></span>. Doing it that way
means you can use public/private key authentication and avoid typing your
password every single time. A fairly comprehensive guide to that can be found
<a href="http://www.securityfocus.com/infocus/1810">here</a>. You can ignore the
server-side configuration; you just need to add your public key on BitBucket&#8217;s
account settings page and you should&nbsp;be&nbsp;set.</p>
<p><strong><span class="caps"><span class="caps">UPDATE</span></span>:</strong>  I didn&#8217;t realize it before, but BitBucket has a <a href="http://bitbucket.org/help/using-ssh/">guide to using <span class="caps"><span class="caps">SSH</span></span> with BitBucket</a>.  It&#8217;s definitely worth&nbsp;looking&nbsp;at.</p>
<p>Now you should be able to use <code>hg push</code> and <code>hg pull</code> on your local machine to
push and pull changes to and from the BitBucket repository. The next step is
getting it set up on the&nbsp;server&nbsp;side.</p>
<h3 id="set-up-your-server">Set Up&nbsp;Your&nbsp;Server</h3>
<p>On your server, use <code>hg clone</code> to clone the BitBucket repository to wherever
you want to serve it from. Edit the <code>.hg/hgrc</code> file in that one and change the
default path to the same value&nbsp;as&nbsp;before:</p>
<div class="codehilite"><pre><span class="na">default</span> <span class="o">=</span> <span class="s">ssh://hg@bitbucket.org/username/repositoryname/</span>
</pre></div>


<p>Once again, set up public/private key authentication; this time between the
server and BitBucket. You can either copy your public and private keys from
your local machine to the server (if you trust/own it) or you can create a new
pair and add its public key to your BitBucket account&nbsp;as&nbsp;well.</p>
<p>While you&#8217;re at it, set up public/private key authentication to go from your
local machine to your server too. It&#8217;ll pay off in the&nbsp;long&nbsp;run.</p>
<p>Now that you&#8217;ve got both sides working, you can develop and deploy&nbsp;like&nbsp;so:</p>
<ul>
<li>Make changes on your local machine, committing as&nbsp;you&nbsp;go.</li>
<li>Push the changes&nbsp;to&nbsp;BitBucket.</li>
<li><span class="caps"><span class="caps">SSH</span></span> into your server and pull the&nbsp;changes&nbsp;down.</li>
<li>Restart the web server process&nbsp;if&nbsp;necessary.</li>
</ul>
<p>Not too bad! Instead of manually managing file transfers you can let Mercurial
do it for you. It&#8217;ll only pull down the files that have changed, and will
always put them in exactly the right spot. That&#8217;s pretty convenient, but we
can&nbsp;do&nbsp;better.</p>
<h2 id="weaving-it-all-together-with-fabric">Weaving it All Together&nbsp;with&nbsp;Fabric</h2>
<p>Being able to push and pull is all well and good, but that&#8217;s still a lot of
typing. You need to enter a command to push your changes, a command to <span class="caps"><span class="caps">SSH</span></span> to
the server, a command to change to the deploy directory, a command to pull the
changes, and a command to restart the server process. That&#8217;s five commands,
which is four commands too many&nbsp;for&nbsp;me.</p>
<p>To automate the process, I use the wonderful <a href="http://fabfile.org/">Fabric</a> tool. If you haven&#8217;t
seen it before you should take a look. To follow along with the rest of the
section you should read the examples on the site and install Fabric on your&nbsp;local&nbsp;machine.</p>
<h3 id="my-current-setup">My&nbsp;Current&nbsp;Setup</h3>
<p>Here&#8217;s the fabfile I use for deploying my site to my host (<a href="http://www.webfaction.com?affiliate=sjl">WebFaction</a>).
It&#8217;s pretty specific to my needs but I&#8217;m sure it will give you an idea of
where&nbsp;to&nbsp;start.</p>
<div class="codehilite"><pre><span class="k">def</span> <span class="nf">prod</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Set the target to production.&quot;&quot;&quot;</span>
    <span class="nb">set</span><span class="p">(</span><span class="n">fab_hosts</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;sjl.webfactional.com&#39;</span><span class="p">])</span>
    <span class="nb">set</span><span class="p">(</span><span class="n">fab_key_filename</span><span class="o">=</span><span class="s">&#39;/Users/sjl/.ssh/stevelosh&#39;</span><span class="p">)</span>
    <span class="nb">set</span><span class="p">(</span><span class="n">remote_app_dir</span><span class="o">=</span><span class="s">&#39;~/webapps/stevelosh/stevelosh&#39;</span><span class="p">)</span>
    <span class="nb">set</span><span class="p">(</span><span class="n">remote_apache_dir</span><span class="o">=</span><span class="s">&#39;~/webapps/stevelosh/apache2&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">deploy</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Deploy the site.&quot;&quot;&quot;</span>
    <span class="n">require</span><span class="p">(</span><span class="s">&#39;fab_hosts&#39;</span><span class="p">,</span> <span class="n">provided_by</span> <span class="o">=</span> <span class="p">[</span><span class="n">prod</span><span class="p">,])</span>
    <span class="n">local</span><span class="p">(</span><span class="s">&quot;hg push&quot;</span><span class="p">)</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&quot;cd $(remote_app_dir); hg pull; hg update&quot;</span><span class="p">)</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&quot;cd $(remote_app_dir); python2.5 manage.py syncdb&quot;</span><span class="p">)</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&quot;$(remote_apache_dir)/bin/stop; sleep 1; $(remote_apache_dir)/bin/start&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">debugon</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Turn debug mode on for the production server.&quot;&quot;&quot;</span>
    <span class="n">require</span><span class="p">(</span><span class="s">&#39;fab_hosts&#39;</span><span class="p">,</span> <span class="n">provided_by</span> <span class="o">=</span> <span class="p">[</span><span class="n">prod</span><span class="p">,])</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&quot;cd $(remote_app_dir); sed -i -e &#39;s/<span class="caps"><span class="caps">DEBUG</span></span> = .*/<span class="caps"><span class="caps">DEBUG</span></span> = True/&#39; deploy.py&quot;</span><span class="p">)</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&quot;$(remote_apache_dir)/bin/stop; sleep 1; $(remote_apache_dir)/bin/start&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">debugoff</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Turn debug mode off for the production server.&quot;&quot;&quot;</span>
    <span class="n">require</span><span class="p">(</span><span class="s">&#39;fab_hosts&#39;</span><span class="p">,</span> <span class="n">provided_by</span> <span class="o">=</span> <span class="p">[</span><span class="n">prod</span><span class="p">,])</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&quot;cd $(remote_app_dir); sed -i -e &#39;s/<span class="caps"><span class="caps">DEBUG</span></span> = .*/<span class="caps"><span class="caps">DEBUG</span></span> = False/&#39; deploy.py&quot;</span><span class="p">)</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&quot;$(remote_apache_dir)/bin/stop; sleep 1; $(remote_apache_dir)/bin/start&quot;</span><span class="p">)</span>
</pre></div>


<p>When I&#8217;m finished committing to my local repository and I want to deploy the
site, I just use the command <code>fab prod deploy</code> on my local machine. Fabric
pushes my local repository to BitBucket, logs into the server (with my public
key&mdash;no typing in passwords), pulls down the new changes from BitBucket
and restarts the&nbsp;server&nbsp;process.</p>
<p>I also set up a couple of debug commands so I can type <code>fab prod debugon</code> and
<code>fab prod debugoff</code> to change the <code>settings.DEBUG</code> option of my Django app.
Sometimes it&#8217;s useful to turn on debug to find out exactly why a page is
breaking on&nbsp;the&nbsp;server.</p>
<h3 id="extending-it">Extending&nbsp;It</h3>
<p>The reason I split off the <code>prod</code> command is so I can set up a separate test
app (on the server) in the future and reuse the <code>deploy</code> and <code>debug</code> commands.
All I&#8217;d need to do is add a <code>test</code> command, which might look something&nbsp;like&nbsp;this:</p>
<div class="codehilite"><pre><span class="k">def</span> <span class="nf">test</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Set the target to test.&quot;&quot;&quot;</span>
    <span class="nb">set</span><span class="p">(</span><span class="n">fab_hosts</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;sjl.webfactional.com&#39;</span><span class="p">])</span>
    <span class="nb">set</span><span class="p">(</span><span class="n">fab_key_filename</span><span class="o">=</span><span class="s">&#39;/Users/sjl/.ssh/stevelosh&#39;</span><span class="p">)</span>
    <span class="nb">set</span><span class="p">(</span><span class="n">remote_app_dir</span> <span class="o">=</span> <span class="s">&#39;~/webapps/stevelosh-test/stevelosh&#39;</span><span class="p">)</span>
    <span class="nb">set</span><span class="p">(</span><span class="n">remote_apache_dir</span> <span class="o">=</span> <span class="s">&#39;~/webapps/stevelosh-test/apache2&#39;</span><span class="p">)</span>
</pre></div>


<p>Deploying the test site would then be a simple <code>fab test deploy</code> command.</p>
<h2 id="why-should-you-try-this">Why Should You&nbsp;Try&nbsp;This?</h2>
<p>After you&#8217;ve gotten all of this set up the first time it will start saving you
time every time you deploy. It also prevents stupid mistakes like <span class="caps"><span class="caps">FTP</span></span>&#8217;ing your
files to the wrong directory on the server. It frees you from those headaches
and lets you concentrate on the real work to be done instead of the busywork.
Plus setting it up again for a second project is a breeze after you&#8217;ve done&nbsp;it&nbsp;once.</p>
<p>Obviously the exact details of this won&#8217;t be a perfect fit for everyone. Maybe
you prefer using git and <a href="http://github.com/">GitHub</a> for version control. I&#8217;m sure there&#8217;s a
similar way to automate the process on that side of the fence. If you decide
to write something about the details of that please let me know and I&#8217;ll link&nbsp;it&nbsp;here.</p>
<p>My hope is that this will at least give you some ideas about saving yourself
some time. If that helps you create better websites, I&#8217;ll be happy. Please
feel free to find me on <a href="http://twitter.com/stevelosh/">Twitter</a> with any questions or thoughts&nbsp;you&nbsp;have!</p>
<h2 id="update">Update</h2>
<p>It&#8217;s been over a year since I originally wrote this entry and I&#8217;ve learned
quite a bit since then. I don&#8217;t have the time right now to go back and rewrite
the entire article, but here are some of the main things that&nbsp;have&nbsp;changed:</p>
<ul>
<li>
<p>I now use <a href="http://clemesha.org/blog/2009/jul/05/modern-python-hacker-tools-virtualenv-fabric-pip/">virtualenv and pip</a> when deploying Django sites. It
  sandboxes each site very nicely and makes it easy&nbsp;to&nbsp;deploy.</p>
</li>
<li>
<p>I no longer go &#8220;through&#8221; BitBucket when deploying &#8212; I push directly from my
  local machine to the server. This eliminates an extra step, and I can always
  push to BitBucket once I&#8217;m done with a series&nbsp;of&nbsp;changes.</p>
</li>
<li>
<p>Fabric is completely different. &#8220;Ownership/maintenance&#8221; of the project has
  transferred to a new person and the format of fabfiles has&nbsp;drastically&nbsp;changed.</p>
</li>
</ul>
<p>Here&#8217;s a sample fabfile from one of the projects I&#8217;m working on now. There are
no comments, but I think most things should be self-explanitory. If you have
any questions just find me on <a href="http://twitter.com/stevelosh/">Twitter</a> and I&#8217;ll be glad to&nbsp;answer&nbsp;them.</p>
<div class="codehilite"><pre><span class="n">from</span> <span class="n">fabric</span><span class="o">.</span><span class="n">api</span> <span class="nb">import</span> <span class="o">*</span>

<span class="n">REMOTE_HG_PATH</span> <span class="o">=</span> <span class="s">&#39;/home/sjl/bin/hg&#39;</span>

<span class="n">def</span> <span class="n">prod</span><span class="p">():</span>
    <span class="s">&quot;&quot;&quot;Set the target to production.&quot;&quot;&quot;</span>
    <span class="n">env</span><span class="o">.</span><span class="n">hosts</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;sjl.webfactional.com&#39;</span><span class="p">]</span>
    <span class="n">env</span><span class="o">.</span><span class="n">remote_app_dir</span> <span class="o">=</span> <span class="s">&#39;webapps/<span class="caps"><span class="caps">SAMPLE</span></span>/<span class="caps"><span class="caps">SAMPLE</span></span>&#39;</span>
    <span class="n">env</span><span class="o">.</span><span class="n">remote_apache_dir</span> <span class="o">=</span> <span class="s">&#39;~/webapps/<span class="caps"><span class="caps">SAMPLE</span></span>/apache2&#39;</span>
    <span class="n">env</span><span class="o">.</span><span class="n">local_settings_file</span> <span class="o">=</span> <span class="s">&#39;local_settings-prod.py&#39;</span>
    <span class="n">env</span><span class="o">.</span><span class="n">remote_push_dest</span> <span class="o">=</span> <span class="s">&#39;ssh://webf/%s&#39;</span> <span class="nv">%</span> <span class="nv">env</span><span class="o">.</span><span class="n">remote_app_dir</span>
    <span class="n">env</span><span class="o">.</span><span class="n">tag</span> <span class="o">=</span> <span class="s">&#39;production&#39;</span>
    <span class="n">env</span><span class="o">.</span><span class="n">venv_name</span> <span class="o">=</span> <span class="s">&#39;SAMPLE_prod&#39;</span>

<span class="n">def</span> <span class="n">test</span><span class="p">():</span>
    <span class="s">&quot;&quot;&quot;Set the target to test.&quot;&quot;&quot;</span>
    <span class="n">env</span><span class="o">.</span><span class="n">hosts</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;sjl.webfactional.com&#39;</span><span class="p">]</span>
    <span class="n">env</span><span class="o">.</span><span class="n">remote_app_dir</span> <span class="o">=</span> <span class="s">&#39;webapps/SAMPLE_test/lindyhub&#39;</span>
    <span class="n">env</span><span class="o">.</span><span class="n">remote_apache_dir</span> <span class="o">=</span> <span class="s">&#39;~/webapps/SAMPLE_test/apache2&#39;</span>
    <span class="n">env</span><span class="o">.</span><span class="n">local_settings_file</span> <span class="o">=</span> <span class="s">&#39;local_settings-test.py&#39;</span>
    <span class="n">env</span><span class="o">.</span><span class="n">remote_push_dest</span> <span class="o">=</span> <span class="s">&#39;ssh://webf/%s&#39;</span> <span class="nv">%</span> <span class="nv">env</span><span class="o">.</span><span class="n">remote_app_dir</span>
    <span class="n">env</span><span class="o">.</span><span class="n">tag</span> <span class="o">=</span> <span class="s">&#39;test&#39;</span>
    <span class="n">env</span><span class="o">.</span><span class="n">venv_name</span> <span class="o">=</span> <span class="s">&#39;SAMPLE_test&#39;</span>

<span class="n">def</span> <span class="n">deploy</span><span class="p">():</span>
    <span class="s">&quot;&quot;&quot;Deploy the site.</span>

<span class="s">    This will also add a local Mercurial tag with the name of the environment</span>
<span class="s">    (test or production) to your the local repository, and then sync it to</span>
<span class="s">    the remote repo as well.</span>

<span class="s">    This is nice because you can easily see which changeset is currently</span>
<span class="s">    deployed to a particular environment in &#39;hg glog&#39;.</span>
<span class="s">    &quot;&quot;&quot;</span>
    <span class="nb">require</span><span class="p">(</span><span class="s">&#39;hosts&#39;</span><span class="p">,</span> <span class="n">provided_by</span><span class="o">=</span><span class="p">[</span><span class="n">prod</span><span class="p">,</span> <span class="n">test</span><span class="p">])</span>
    <span class="nb">require</span><span class="p">(</span><span class="s">&#39;remote_app_dir&#39;</span><span class="p">,</span> <span class="n">provided_by</span><span class="o">=</span><span class="p">[</span><span class="n">prod</span><span class="p">,</span> <span class="n">test</span><span class="p">])</span>
    <span class="nb">require</span><span class="p">(</span><span class="s">&#39;remote_apache_dir&#39;</span><span class="p">,</span> <span class="n">provided_by</span><span class="o">=</span><span class="p">[</span><span class="n">prod</span><span class="p">,</span> <span class="n">test</span><span class="p">])</span>
    <span class="nb">require</span><span class="p">(</span><span class="s">&#39;local_settings_file&#39;</span><span class="p">,</span> <span class="n">provided_by</span><span class="o">=</span><span class="p">[</span><span class="n">prod</span><span class="p">,</span> <span class="n">test</span><span class="p">])</span>
    <span class="nb">require</span><span class="p">(</span><span class="s">&#39;remote_push_dest&#39;</span><span class="p">,</span> <span class="n">provided_by</span><span class="o">=</span><span class="p">[</span><span class="n">prod</span><span class="p">,</span> <span class="n">test</span><span class="p">])</span>
    <span class="nb">require</span><span class="p">(</span><span class="s">&#39;tag&#39;</span><span class="p">,</span> <span class="n">provided_by</span><span class="o">=</span><span class="p">[</span><span class="n">prod</span><span class="p">,</span> <span class="n">test</span><span class="p">])</span>
    <span class="nb">require</span><span class="p">(</span><span class="s">&#39;venv_name&#39;</span><span class="p">,</span> <span class="n">provided_by</span><span class="o">=</span><span class="p">[</span><span class="n">prod</span><span class="p">,</span> <span class="n">test</span><span class="p">])</span>

    <span class="nb">local</span><span class="p">(</span><span class="s">&quot;hg tag --local --force %s&quot;</span> <span class="nv">%</span> <span class="nv">env</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
    <span class="nb">local</span><span class="p">(</span><span class="s">&quot;hg push %s --remotecmd %s&quot;</span> <span class="nv">%</span> <span class="err">(</span><span class="nv">env</span><span class="o">.</span><span class="n">remote_push_dest</span><span class="p">,</span> <span class="n">REMOTE_HG_PATH</span><span class="p">))</span>
    <span class="n">put</span><span class="p">(</span><span class="s">&quot;.hg/localtags&quot;</span><span class="p">,</span> <span class="s">&quot;%s/.hg/localtags&quot;</span> <span class="nv">%</span> <span class="nv">env</span><span class="o">.</span><span class="n">remote_app_dir</span><span class="p">)</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&quot;cd %s; hg update -C %s&quot;</span> <span class="nv">%</span> <span class="err">(</span><span class="nv">env</span><span class="o">.</span><span class="n">remote_app_dir</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">tag</span><span class="p">))</span>
    <span class="n">put</span><span class="p">(</span><span class="s">&quot;%s&quot;</span> <span class="nv">%</span> <span class="nv">env</span><span class="o">.</span><span class="n">local_settings_file</span><span class="p">,</span> <span class="s">&quot;%s/local_settings.py&quot;</span> <span class="nv">%</span> <span class="nv">env</span><span class="o">.</span><span class="n">remote_app_dir</span><span class="p">)</span>

    <span class="n">run</span><span class="p">(</span><span class="s">&quot;workon %s; cd %s; python manage.py syncdb&quot;</span> <span class="nv">%</span> <span class="err">(</span><span class="nv">env</span><span class="o">.</span><span class="n">venv_name</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">remote_app_dir</span><span class="p">))</span>
    <span class="n">restart</span><span class="p">()</span>

<span class="n">def</span> <span class="n">restart</span><span class="p">():</span>
    <span class="s">&quot;&quot;&quot;Restart apache on the server.&quot;&quot;&quot;</span>
    <span class="nb">require</span><span class="p">(</span><span class="s">&#39;hosts&#39;</span><span class="p">,</span> <span class="n">provided_by</span><span class="o">=</span><span class="p">[</span><span class="n">prod</span><span class="p">,</span> <span class="n">test</span><span class="p">])</span>
    <span class="nb">require</span><span class="p">(</span><span class="s">&#39;remote_apache_dir&#39;</span><span class="p">,</span> <span class="n">provided_by</span><span class="o">=</span><span class="p">[</span><span class="n">prod</span><span class="p">,</span> <span class="n">test</span><span class="p">])</span>

    <span class="n">run</span><span class="p">(</span><span class="s">&quot;%s/bin/stop; sleep 2; %s/bin/start&quot;</span> <span class="nv">%</span> <span class="err">(</span><span class="nv">env</span><span class="o">.</span><span class="n">remote_apache_dir</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">remote_apache_dir</span><span class="p">))</span>

<span class="n">def</span> <span class="n">debugon</span><span class="p">():</span>
    <span class="s">&quot;&quot;&quot;Turn debug mode on for the server.&quot;&quot;&quot;</span>
    <span class="nb">require</span><span class="p">(</span><span class="s">&#39;hosts&#39;</span><span class="p">,</span> <span class="n">provided_by</span><span class="o">=</span><span class="p">[</span><span class="n">prod</span><span class="p">,</span> <span class="n">test</span><span class="p">])</span>
    <span class="nb">require</span><span class="p">(</span><span class="s">&#39;remote_app_dir&#39;</span><span class="p">,</span> <span class="n">provided_by</span><span class="o">=</span><span class="p">[</span><span class="n">prod</span><span class="p">,</span> <span class="n">test</span><span class="p">])</span>
    <span class="nb">require</span><span class="p">(</span><span class="s">&#39;remote_apache_dir&#39;</span><span class="p">,</span> <span class="n">provided_by</span><span class="o">=</span><span class="p">[</span><span class="n">prod</span><span class="p">,</span> <span class="n">test</span><span class="p">])</span>

    <span class="n">run</span><span class="p">(</span><span class="s">&quot;cd %s; sed -i -e &#39;s/<span class="caps"><span class="caps">DEBUG</span></span> = .*/<span class="caps"><span class="caps">DEBUG</span></span> = True/&#39; local_settings.py&quot;</span> <span class="nv">%</span> <span class="nv">env</span><span class="o">.</span><span class="n">remote_app_dir</span><span class="p">)</span>
    <span class="n">restart</span><span class="p">()</span>

<span class="n">def</span> <span class="n">debugoff</span><span class="p">():</span>
    <span class="s">&quot;&quot;&quot;Turn debug mode off for the server.&quot;&quot;&quot;</span>
    <span class="nb">require</span><span class="p">(</span><span class="s">&#39;hosts&#39;</span><span class="p">,</span> <span class="n">provided_by</span><span class="o">=</span><span class="p">[</span><span class="n">prod</span><span class="p">,</span> <span class="n">test</span><span class="p">])</span>
    <span class="nb">require</span><span class="p">(</span><span class="s">&#39;remote_app_dir&#39;</span><span class="p">,</span> <span class="n">provided_by</span><span class="o">=</span><span class="p">[</span><span class="n">prod</span><span class="p">,</span> <span class="n">test</span><span class="p">])</span>
    <span class="nb">require</span><span class="p">(</span><span class="s">&#39;remote_apache_dir&#39;</span><span class="p">,</span> <span class="n">provided_by</span><span class="o">=</span><span class="p">[</span><span class="n">prod</span><span class="p">,</span> <span class="n">test</span><span class="p">])</span>

    <span class="n">run</span><span class="p">(</span><span class="s">&quot;cd %s; sed -i -e &#39;s/<span class="caps"><span class="caps">DEBUG</span></span> = .*/<span class="caps"><span class="caps">DEBUG</span></span> = False/&#39; local_settings.py&quot;</span> <span class="nv">%</span> <span class="nv">env</span><span class="o">.</span><span class="n">remote_app_dir</span><span class="p">)</span>
    <span class="n">restart</span><span class="p">()</span>
</pre></div>
                
            <!-- Hyde::Article::End -->
        
    </div>

                    
                
            </div>

            <div class="hrb">&nbsp;</div>

            <footer>
                I'm also on
                <a href="http://bitbucket.org/sjl/">BitBucket</a>,
                <a href="http://github.com/sjl/">GitHub</a>,
                <a href="http://twitter.com/stevelosh/">Twitter</a>,
                <a href="http://forrst.com/people/stevelosh/">Forrst</a>
                and
                <a href="http://flickr.com/photos/sjl7678/">Flickr</a>.
                I've got <a href="#" class="rhythm">rhythm</a>.
            </footer>
        </div>
    </body>

</html>
